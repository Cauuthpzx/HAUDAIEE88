<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Agent Hub — Quản lý</title>
  <link rel="stylesheet" href="/lib/layui/css/layui.css">
  <style>
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; }

    /* ── Logo ── */
    .layui-logo .layui-icon { font-size: 26px; color: #ff4d4f; margin-right: 6px; vertical-align: middle; }
    .layui-logo span { color: #ff4d4f; vertical-align: middle; font-weight: bold; }

    /* ── Sidebar ── */
    .hub-sidebar {
      position: fixed;
      top: 50px;
      left: 0;
      bottom: 0;
      width: 200px;
      background: #20222A;
      overflow-y: auto;
      transition: width .3s;
      z-index: 999;
    }
    .hub-sidebar .layui-nav {
      background: transparent;
      width: 100%;
    }
    .hub-sidebar .layui-nav .layui-nav-item a {
      color: #ccc;
    }
    .hub-sidebar .layui-nav .layui-nav-item a:hover,
    .hub-sidebar .layui-nav .layui-this a {
      color: #fff;
      background: rgba(255,255,255,0.08);
    }


    /* ── Body ── */
    .hub-body {
      position: fixed;
      top: 50px;
      left: 200px;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: left .3s;
    }

    /* ── Collapsed: xem layui.css (.layui-layout-collapse) ── */

    /* ── Tabs ── */
    .hub-body .layui-tabs {
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .hub-body .layui-tabs-body {
      flex: 1;
      padding: 0;
      overflow: hidden;
    }
    .hub-body .layui-tabs-item {
      height: 100%;
    }
    .hub-body .layui-tabs-item iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    /* ── Flag icon ── */
    .hub-flag { display: inline-block; width: 20px; height: 14px; vertical-align: middle; margin-right: 5px; }
  </style>
</head>
<body>

<div class="layui-layout layui-layout-admin">
  <!-- Header -->
  <div class="layui-header">
    <div class="layui-logo layui-hide-xs">
      <i class="layui-icon layui-icon-firefox"></i><span>FIRE</span>
    </div>
    <ul class="layui-nav layui-layout-left">
      <!-- Mobile menu toggle -->
      <li class="layui-nav-item layui-show-xs-inline-block layui-hide-sm" lay-header-event="menuLeft">
        <i class="layui-icon layui-icon-spread-left"></i>
      </li>
      <li class="layui-nav-item layui-hide-xs">
        <a href="javascript:;" id="btnToggle" title="Thu gọn menu"><i class="layui-icon layui-icon-shrink-right"></i></a>
      </li>
      <li class="layui-nav-item layui-hide-xs">
        <a href="javascript:;" id="btnRefresh" title="Tải lại trang"><i class="layui-icon layui-icon-refresh"></i></a>
      </li>
    </ul>
    <ul class="layui-nav layui-layout-right" lay-filter="hub-account">
      <li class="layui-nav-item" id="navLang">
        <a href="javascript:;"><img id="langFlag" class="hub-flag" src=""><span id="langLabel" style="vertical-align:middle;"></span></a>
        <dl class="layui-nav-child">
          <dd><a href="javascript:;" data-lang="vi"><img src="/images/vn.gif" class="hub-flag"><span style="vertical-align:middle;">Tiếng Việt</span></a></dd>
          <dd><a href="javascript:;" data-lang="en"><img src="/images/uk.gif" class="hub-flag"><span style="vertical-align:middle;">English</span></a></dd>
          <dd><a href="javascript:;" data-lang="zh-CN"><img src="/images/china.gif" class="hub-flag"><span style="vertical-align:middle;">中文</span></a></dd>
        </dl>
      </li>
      <li class="layui-nav-item">
        <a href="javascript:;" id="btnFullscreen" title="Toàn màn hình"><i class="layui-icon layui-icon-screen-full"></i></a>
      </li>
      <li class="layui-nav-item layui-hide layui-show-sm-inline-block">
        <a href="javascript:;">
          <img src="//unpkg.com/outeres@0.0.10/img/layui/icon-v2.png" class="layui-nav-img">
          <span id="userInfo"></span>
        </a>
        <dl class="layui-nav-child">
          <dd><a href="javascript:;" id="navProfile" data-i18n="accountInfo">Thông tin tài khoản</a></dd>
          <dd><a href="javascript:;" id="navSettings" data-i18n="settings">Cài đặt</a></dd>
          <hr>
          <dd style="text-align: center;"><a href="javascript:;" id="navLogout" data-i18n="logout">Đăng xuất</a></dd>
        </dl>
      </li>
      <li class="layui-nav-item" lay-header-event="menuRight">
        <a href="javascript:;">
          <i class="layui-icon layui-icon-more-vertical"></i>
        </a>
      </li>
    </ul>
  </div>

  <!-- Sidebar -->
  <div class="hub-sidebar">
    <ul class="layui-nav layui-nav-tree" lay-shrink="all" lay-filter="hub-menu">
      <!-- 1. Quản lí hội viên -->
      <li class="layui-nav-item layui-nav-itemed">
        <a href="javascript:;">
          <i class="layui-icon layui-icon-username" style="margin-right: 6px;"></i><span data-i18n="memberMgmt">Quản lí hội viên</span>
        </a>
        <dl class="layui-nav-child">
          <dd class="layui-this">
            <a href="javascript:;" data-url="/pages/agent/user.html" data-title-i18n="members" data-title="Hội viên" data-i18n="members">Hội viên</a>
          </dd>
        </dl>
      </li>
      <!-- 2. Mã giới thiệu -->
      <li class="layui-nav-item">
        <a href="javascript:;">
          <i class="layui-icon layui-icon-vercode" style="margin-right: 6px;"></i><span data-i18n="referralCode">Mã giới thiệu</span>
        </a>
        <dl class="layui-nav-child">
          <dd>
            <a href="javascript:;" data-url="/pages/agent/inviteList.html" data-title-i18n="referralCode" data-title="Mã giới thiệu" data-i18n="referralCode">Mã giới thiệu</a>
          </dd>
        </dl>
      </li>
      <!-- 3. Báo cáo -->
      <li class="layui-nav-item">
        <a href="javascript:;">
          <i class="layui-icon layui-icon-tabs" style="margin-right: 6px;"></i><span data-i18n="reports">Báo cáo</span>
        </a>
        <dl class="layui-nav-child">
          <dd>
            <a href="javascript:;" data-url="/pages/agent/reportLottery.html" data-title-i18n="lotteryReport" data-title="BC xổ số" data-i18n="lotteryReport">BC xổ số</a>
          </dd>
          <dd>
            <a href="javascript:;" data-url="/pages/agent/reportFunds.html" data-title-i18n="transStatement" data-title="Sao kê giao dịch" data-i18n="transStatement">Sao kê giao dịch</a>
          </dd>
          <dd>
            <a href="javascript:;" data-url="/pages/agent/reportThirdGame.html" data-title-i18n="providerReport" data-title="BC nhà cung cấp" data-i18n="providerReport">BC nhà cung cấp</a>
          </dd>
        </dl>
      </li>
      <!-- 4. Rút hoa hồng -->
      <li class="layui-nav-item">
        <a href="javascript:;">
          <i class="layui-icon layui-icon-dollar" style="margin-right: 6px;"></i><span data-i18n="commission">Rút hoa hồng</span>
        </a>
        <dl class="layui-nav-child">
          <dd>
            <a href="javascript:;" data-url="/pages/agent/depositAndWithdrawal.html" data-title-i18n="deposit" data-title="Nạp tiền" data-i18n="deposit">Nạp tiền</a>
          </dd>
          <dd>
            <a href="javascript:;" data-url="/pages/agent/withdrawalsRecord.html" data-title-i18n="withdraw" data-title="Rút tiền" data-i18n="withdraw">Rút tiền</a>
          </dd>
        </dl>
      </li>
      <!-- 5. Đơn cược -->
      <li class="layui-nav-item">
        <a href="javascript:;">
          <i class="layui-icon layui-icon-chart-screen" style="margin-right: 6px;"></i><span data-i18n="betOrders">Đơn cược</span>
        </a>
        <dl class="layui-nav-child">
          <dd>
            <a href="javascript:;" data-url="/pages/agent/bet.html" data-title-i18n="lotteryBet" data-title="Đơn cược xổ số" data-i18n="lotteryBet">Đơn cược xổ số</a>
          </dd>
          <dd>
            <a href="javascript:;" data-url="/pages/agent/betOrder.html" data-title-i18n="thirdPartyBet" data-title="Cược bên thứ 3" data-i18n="thirdPartyBet">Cược bên thứ 3</a>
          </dd>
        </dl>
      </li>
      <!-- 6. Khách hàng -->
      <li class="layui-nav-item">
        <a href="javascript:;">
          <i class="layui-icon layui-icon-survey" style="margin-right: 6px;"></i><span data-i18n="customer">Khách hàng</span>
        </a>
        <dl class="layui-nav-child">
          <dd>
            <a href="javascript:;" data-url="/pages/agent/editPassword.html" data-title-i18n="changeLoginPw" data-title="Đổi MK đăng nhập" data-i18n="changeLoginPw">Đổi MK đăng nhập</a>
          </dd>
          <dd>
            <a href="javascript:;" data-url="/pages/agent/editFundPassword.html" data-title-i18n="changeFundPw" data-title="Đổi MK giao dịch" data-i18n="changeFundPw">Đổi MK giao dịch</a>
          </dd>
        </dl>
      </li>
      <!-- 7. Tỉ lệ hoàn trả -->
      <li class="layui-nav-item">
        <a href="javascript:;">
          <i class="layui-icon layui-icon-list" style="margin-right: 6px;"></i><span data-i18n="rebateRate">Tỉ lệ hoàn trả</span>
        </a>
        <dl class="layui-nav-child">
          <dd>
            <a href="javascript:;" data-url="/pages/agent/getRebateOddsPanel.html" data-title-i18n="rebateRate" data-title="Tỉ lệ hoàn trả" data-i18n="rebateRate">Tỉ lệ hoàn trả</a>
          </dd>
        </dl>
      </li>
      <!-- 8. Quản lý (admin only) -->
      <li class="layui-nav-item" id="menuManage" style="display:none;">
        <a href="javascript:;">
          <i class="layui-icon layui-icon-set" style="margin-right: 6px;"></i><span data-i18n="management">Quản lý</span>
        </a>
        <dl class="layui-nav-child">
          <dd>
            <a href="javascript:;" data-url="/pages/manage/manageAgents.html" data-title-i18n="manageAgents" data-title="Quản lý Agents" data-i18n="manageAgents">Quản lý Agents</a>
          </dd>
          <dd>
            <a href="javascript:;" data-url="/pages/manage/manageUsers.html" data-title-i18n="manageUsers" data-title="Quản lý Users" data-i18n="manageUsers">Quản lý Users</a>
          </dd>
          <dd>
            <a href="javascript:;" data-url="/pages/manage/syncStatus.html" data-title-i18n="syncStatus" data-title="Đồng bộ Cache" data-i18n="syncStatus">Đồng bộ Cache</a>
          </dd>
        </dl>
      </li>
    </ul>
  </div>

  <!-- Body -->
  <div class="hub-body">
    <div class="layui-tabs layui-hide-v" id="hubTabs" lay-options="{closable: true, headerMode: 'scroll'}">
      <ul class="layui-tabs-header"></ul>
      <div class="layui-tabs-body"></div>
    </div>
  </div>
</div>

  <script src="/lib/layui/layui.js"></script>
  <script src="/js/hub-api.js"></script>
  <script src="/js/hub-lang.js"></script>
  <script>
    // ── Auth guard ──
    if (!HubAPI.isLoggedIn()) {
      window.location.href = '/pages/login.html';
    }

    // ── Init i18n trước khi layui.use ──
    HubLang.init();
    document.title = HubLang.t('adminPageTitle');

    layui.use(['element', 'tabs', 'dropdown', 'layer', 'util', 'i18n'], function () {
      var $ = layui.$;
      var element = layui.element;
      var tabs = layui.tabs;
      var dropdown = layui.dropdown;
      var layer = layui.layer;
      var util = layui.util;
      var openedTabs = {};
      var TABS_ID = 'hubTabs';

      // ── Hiển thị user info ──
      var user = HubAPI.getUser();
      if (user) {
        document.getElementById('userInfo').textContent = user.username;
        if (user.role === 'admin') {
          document.getElementById('menuManage').style.display = '';
        }
      }

      // ── i18n: apply DOM + update lang label ──
      function applyI18n() {
        HubLang.applyDOM();
        var lang = HubLang.getLang();
        var info = HubLang.LANGS[lang];
        document.getElementById('langLabel').textContent = info ? info.short : lang;
        document.getElementById('langFlag').src = info ? info.flag : '';
        $('[data-title-i18n]').each(function () {
          $(this).attr('data-title', HubLang.t($(this).attr('data-title-i18n')));
        });
      }
      applyI18n();

      // ── Header nav events (language switch + account) ──
      element.on('nav(hub-account)', function (elem) {
        // Language switch
        var lang = elem.attr('data-lang');
        if (lang) {
          HubLang.setLang(lang);
          applyI18n();
          dropdownInst.config.data = getContextMenuData();
          // Reload tất cả iframe để sub-pages áp dụng ngôn ngữ mới
          document.querySelectorAll('.hub-body iframe').forEach(function (iframe) {
            iframe.contentWindow.location.reload();
          });
          // Cập nhật document.title
          var activeIframe = document.querySelector('.hub-body .layui-tabs-item.layui-show iframe');
          if (activeIframe) {
            var src = activeIframe.getAttribute('src');
            var menuLink = document.querySelector('.hub-sidebar a[data-url="' + src + '"]');
            if (menuLink) {
              var titleKey = menuLink.getAttribute('data-title-i18n');
              if (titleKey) document.title = 'Agent Hub — ' + HubLang.t(titleKey);
            }
          } else {
            document.title = HubLang.t('adminPageTitle');
          }
          return;
        }
        // Logout
        if (elem.attr('id') === 'navLogout') {
          HubAPI.logout();
          return;
        }
        // Open tab
        var url = elem.attr('data-url');
        var title = elem.attr('data-title');
        if (!url) return;
        if (openedTabs[url]) {
          tabs.change(TABS_ID, url);
        } else {
          tabs.add(TABS_ID, {
            title: title,
            content: '<iframe src="' + url + '"></iframe>',
            id: url,
            done: function (data) {
              dropdown.render($.extend({}, dropdownInst.config, { elem: data.headerItem }));
            }
          });
          openedTabs[url] = true;
        }
        document.title = 'Agent Hub — ' + (title || '');
      });

      // ── Header events (layui util.event pattern) ──
      util.event('lay-header-event', {
        menuLeft: function () {
          document.getElementById('btnToggle').click();
        },
        menuRight: function () {
          layer.open({
            type: 1,
            title: HubLang.t('options'),
            content: '<div style="padding: 15px;"><p>' + HubLang.t('noOptions') + '</p></div>',
            area: ['260px', '100%'],
            offset: 'rt',
            anim: 'slideLeft',
            shadeClose: true,
            scrollbar: false
          });
        }
      });

      // ── Right-click context menu cho tab header ──
      function getContextMenuData() {
        return [
          { title: HubLang.t('closeTab'), action: 'close', mode: 'this' },
          { title: HubLang.t('closeOther'), action: 'close', mode: 'other' },
          { title: HubLang.t('closeRight'), action: 'close', mode: 'right' },
          { type: '-' },
          { title: HubLang.t('closeAll'), action: 'close', mode: 'all' }
        ];
      }
      var dropdownInst = dropdown.render({
        elem: '#' + TABS_ID + ' .layui-tabs-header>li',
        trigger: 'contextmenu',
        data: getContextMenuData(),
        click: function (data) {
          var index = this.elem.index();
          if (data.mode === 'this') {
            tabs.close(TABS_ID, index);
          } else {
            tabs.closeMult(TABS_ID, data.mode, index);
          }
        }
      });

      // ── Click menu → mở tab hoặc chuyển sang tab đã mở ──
      element.on('nav(hub-menu)', function (elem) {
        var url = elem.attr('data-url');
        var titleKey = elem.attr('data-title-i18n');
        var title = titleKey ? HubLang.t(titleKey) : elem.attr('data-title');
        if (!url) return;

        if (openedTabs[url]) {
          tabs.change(TABS_ID, url);
        } else {
          tabs.add(TABS_ID, {
            title: title,
            content: '<iframe src="' + url + '"></iframe>',
            id: url,
            done: function (data) {
              dropdown.render($.extend({}, dropdownInst.config, { elem: data.headerItem }));
            }
          });
          openedTabs[url] = true;
        }
        document.title = 'Agent Hub — ' + (title || '');
      });

      // ── Xoá tab → dọn dẹp openedTabs ──
      tabs.on('close(' + TABS_ID + ')', function (data) {
        var id = data.id;
        if (id) delete openedTabs[id];
      });

      // ── Toggle sidebar ──
      var LAYOUT = document.querySelector('.layui-layout-admin');
      var toggleIcon = document.querySelector('#btnToggle .layui-icon');
      document.getElementById('btnToggle').addEventListener('click', function () {
        var collapsed = LAYOUT.classList.toggle('layui-layout-collapse');
        if (collapsed) {
          toggleIcon.className = 'layui-icon layui-icon-spread-left';
          document.querySelectorAll('.hub-sidebar .layui-nav-itemed').forEach(function (el) { el.classList.remove('layui-nav-itemed'); });
        } else {
          toggleIcon.className = 'layui-icon layui-icon-shrink-right';
        }
      });

      // ── Refresh tab hiện tại ──
      document.getElementById('btnRefresh').addEventListener('click', function () {
        var active = document.querySelector('.hub-body .layui-tabs-item.layui-show iframe');
        if (active) active.contentWindow.location.reload();
      });

      // ── Fullscreen ──
      var fsIcon = document.querySelector('#btnFullscreen .layui-icon');
      document.getElementById('btnFullscreen').addEventListener('click', function () {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
          fsIcon.className = 'layui-icon layui-icon-screen-restore';
        } else {
          document.exitFullscreen();
          fsIcon.className = 'layui-icon layui-icon-screen-full';
        }
      });

      // ── Layer tips cho header buttons (i18n) ──
      var tipKeys = { btnToggle: 'toggleMenu', btnRefresh: 'reload', btnFullscreen: 'fullscreen' };
      $('#btnToggle, #btnRefresh, #btnFullscreen').each(function () {
        var el = this;
        el.removeAttribute('title');
        $(el).on('mouseenter', function () {
          layer.tips(HubLang.t(tipKeys[el.id]), el, { tips: [3, '#393D49'], time: 1500 });
        }).on('mouseleave', function () {
          layer.closeAll('tips');
        });
      });

      // ── Layer tips cho sidebar khi collapsed (i18n) ──
      $('.hub-sidebar .layui-nav-item > a').each(function () {
        var el = this;
        var span = $(el).find('span[data-i18n]');
        if (!span.length) return;
        var key = span.attr('data-i18n');
        $(el).on('mouseenter', function () {
          if (!LAYOUT.classList.contains('layui-layout-collapse')) return;
          layer.tips(HubLang.t(key), el, { tips: [2, '#393D49'], time: 1500 });
        }).on('mouseleave', function () {
          layer.closeAll('tips');
        });
      });

      // Auto-load trang đầu tiên
      var firstLink = document.querySelector('.hub-sidebar .layui-this a[data-url]');
      if (firstLink) firstLink.click();
    });
  </script>
</body>
</html>
