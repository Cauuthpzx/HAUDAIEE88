<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Agent Hub — Quản lý</title>
  <link rel="stylesheet" href="/lib/layui/css/layui.css">
  <style>
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; }

    /* ── Logo ── */
    .hub-logo {
      position: fixed;
      top: 0; left: 0;
      width: 200px;
      height: 50px;
      line-height: 50px;
      background: #20222A;
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      z-index: 101;
      transition: width .3s;
    }
    .hub-logo .layui-icon { font-size: 26px; color: #ff4d4f; margin-right: 8px; vertical-align: middle; }
    .hub-logo span { vertical-align: middle; transition: opacity .3s; }

    /* ── Header ── */
    .layui-header {
      height: 50px;
      background: #20222A;
      color: #fff;
      display: flex;
      align-items: center;
      padding: 0 15px;
      position: fixed;
      top: 0; left: 200px; right: 0;
      z-index: 100;
      transition: left .3s;
    }
    .hub-header-right-nav {
      background: transparent !important;
      padding: 0;
      margin-left: auto;
    }
    .hub-header-right-nav .layui-nav-bar { display: none; }
    .hub-header-right-nav .layui-nav-item > a { color: #ccc !important; height: 50px; line-height: 50px; }
    .hub-header-right-nav .layui-nav-item:hover > a { color: #fff !important; }
    .hub-header-right-nav .layui-nav-item > a > .layui-icon { font-size: 18px; }
    .hub-header-right-nav .layui-nav-more { border-top-color: #ccc; border-width: 5px; margin-left: 4px; }
    .hub-header-right-nav .layui-nav-item:hover .layui-nav-more { border-top-color: #fff; }
    .hub-header-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      color: #ccc;
      cursor: pointer;
      border-radius: 4px;
      transition: all .2s;
    }
    .hub-header-btn:hover { color: #fff; background: rgba(255,255,255,.1); }
    .hub-header-btn .layui-icon { font-size: 18px; }

    .hub-user-info {
      color: #aaa;
      font-size: 13px;
      margin-right: 10px;
    }
    .hub-user-info b { color: #fff; }

    /* ── Sidebar ── */
    .hub-sidebar {
      position: fixed;
      top: 50px;
      left: 0;
      bottom: 0;
      width: 200px;
      background: #20222A;
      overflow-y: auto;
      transition: width .3s;
    }
    .hub-sidebar .layui-nav {
      background: transparent;
      width: 100%;
    }
    .hub-sidebar .layui-nav .layui-nav-item a {
      color: #ccc;
    }
    .hub-sidebar .layui-nav .layui-nav-item a:hover,
    .hub-sidebar .layui-nav .layui-this a {
      color: #fff;
      background: rgba(255,255,255,0.08);
    }
    .hub-sidebar .layui-nav-bar { display: none; }

    /* ── Body ── */
    .hub-body {
      position: fixed;
      top: 50px;
      left: 200px;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: left .3s;
    }

    /* ── Collapsed ── */
    .hub-sidebar .layui-nav-item > a > span { transition: opacity .3s; }
    body.hub-collapsed .hub-logo { width: 60px; }
    body.hub-collapsed .hub-logo .layui-icon { margin-right: 0 !important; font-size: 28px; }
    body.hub-collapsed .hub-logo span { display: none; }
    body.hub-collapsed .layui-header { left: 60px; }
    body.hub-collapsed .hub-sidebar { width: 60px; }
    body.hub-collapsed .hub-body { left: 60px; }
    body.hub-collapsed .hub-sidebar .layui-nav.layui-nav-tree { width: 60px; }
    body.hub-collapsed .hub-sidebar .layui-nav-item > a > span { display: none; }
    body.hub-collapsed .hub-sidebar .layui-nav-item > a > .layui-icon:first-child { width: 100%; margin-right: 0 !important; text-align: center; font-size: 20px; }
    body.hub-collapsed .hub-sidebar .layui-nav-more { display: none !important; }
    body.hub-collapsed .hub-sidebar .layui-nav-child { display: none !important; }
    body.hub-collapsed .hub-sidebar .layui-nav-item > a { padding-left: 0; padding-right: 0; text-align: center; }

    /* ── Tabs ── */
    .hub-body .layui-tabs {
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .hub-body .layui-tabs-body {
      flex: 1;
      padding: 0;
      overflow: hidden;
    }
    .hub-body .layui-tabs-item {
      height: 100%;
    }
    .hub-body .layui-tabs-item iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
  </style>
</head>
<body>

  <!-- Logo -->
  <div class="hub-logo">
    <i class="layui-icon layui-icon-firefox"></i><span>Agent Hub</span>
  </div>

  <!-- Header -->
  <div class="layui-header">
    <a class="hub-header-btn" id="btnToggle" title="Thu gọn menu"><i class="layui-icon layui-icon-shrink-right"></i></a>
    <a class="hub-header-btn" id="btnRefresh" title="Tải lại trang"><i class="layui-icon layui-icon-refresh"></i></a>
    <ul class="layui-nav hub-header-right-nav" lay-bar="disabled" lay-filter="hub-account">
      <li class="layui-nav-item" lay-unselect>
        <a href="javascript:;" id="btnFullscreen" title="Toàn màn hình"><i class="layui-icon layui-icon-screen-full"></i></a>
      </li>
      <li class="layui-nav-item layui-hide layui-show-sm-inline-block" lay-unselect>
        <a href="javascript:;">
          <img src="//unpkg.com/outeres@0.0.10/img/layui/icon-v2.png" class="layui-nav-img">
          <span id="userInfo"></span>
        </a>
        <dl class="layui-nav-child">
          <dd><a href="javascript:;" data-url="/pages/agent/editPassword.html" data-title="Đổi MK đăng nhập">Đổi MK đăng nhập</a></dd>
          <dd><a href="javascript:;" data-url="/pages/agent/editFundPassword.html" data-title="Đổi MK giao dịch">Đổi MK giao dịch</a></dd>
          <hr>
          <dd style="text-align: center;"><a href="javascript:;" id="navLogout">Đăng xuất</a></dd>
        </dl>
      </li>
      <li class="layui-nav-item" lay-unselect>
        <a href="javascript:;" id="btnMore" title="Tuỳ chọn"><i class="layui-icon layui-icon-more-vertical"></i></a>
      </li>
    </ul>
  </div>

  <!-- Sidebar -->
  <div class="hub-sidebar">
    <ul class="layui-nav layui-nav-tree" lay-shrink="all" lay-filter="hub-menu">
      <!-- 1. Quản lí hội viên -->
      <li class="layui-nav-item layui-nav-itemed">
        <a href="javascript:;">
          <i class="layui-icon layui-icon-username" style="margin-right: 6px;"></i><span>Quản lí hội viên</span>
        </a>
        <dl class="layui-nav-child">
          <dd class="layui-this">
            <a href="javascript:;" data-url="/pages/agent/user.html" data-title="Hội viên">Hội viên</a>
          </dd>
        </dl>
      </li>
      <!-- 2. Mã giới thiệu -->
      <li class="layui-nav-item">
        <a href="javascript:;">
          <i class="layui-icon layui-icon-vercode" style="margin-right: 6px;"></i><span>Mã giới thiệu</span>
        </a>
        <dl class="layui-nav-child">
          <dd>
            <a href="javascript:;" data-url="/pages/agent/inviteList.html" data-title="Mã giới thiệu">Mã giới thiệu</a>
          </dd>
        </dl>
      </li>
      <!-- 3. Báo cáo -->
      <li class="layui-nav-item">
        <a href="javascript:;">
          <i class="layui-icon layui-icon-tabs" style="margin-right: 6px;"></i><span>Báo cáo</span>
        </a>
        <dl class="layui-nav-child">
          <dd>
            <a href="javascript:;" data-url="/pages/agent/reportLottery.html" data-title="BC xổ số">BC xổ số</a>
          </dd>
          <dd>
            <a href="javascript:;" data-url="/pages/agent/reportFunds.html" data-title="Sao kê giao dịch">Sao kê giao dịch</a>
          </dd>
          <dd>
            <a href="javascript:;" data-url="/pages/agent/reportThirdGame.html" data-title="BC nhà cung cấp">BC nhà cung cấp</a>
          </dd>
        </dl>
      </li>
      <!-- 4. Rút hoa hồng -->
      <li class="layui-nav-item">
        <a href="javascript:;">
          <i class="layui-icon layui-icon-dollar" style="margin-right: 6px;"></i><span>Rút hoa hồng</span>
        </a>
        <dl class="layui-nav-child">
          <dd>
            <a href="javascript:;" data-url="/pages/agent/depositAndWithdrawal.html" data-title="Nạp tiền">Nạp tiền</a>
          </dd>
          <dd>
            <a href="javascript:;" data-url="/pages/agent/withdrawalsRecord.html" data-title="Rút tiền">Rút tiền</a>
          </dd>
        </dl>
      </li>
      <!-- 5. Đơn cược -->
      <li class="layui-nav-item">
        <a href="javascript:;">
          <i class="layui-icon layui-icon-chart-screen" style="margin-right: 6px;"></i><span>Đơn cược</span>
        </a>
        <dl class="layui-nav-child">
          <dd>
            <a href="javascript:;" data-url="/pages/agent/bet.html" data-title="Đơn cược xổ số">Đơn cược xổ số</a>
          </dd>
          <dd>
            <a href="javascript:;" data-url="/pages/agent/betOrder.html" data-title="Cược bên thứ 3">Cược bên thứ 3</a>
          </dd>
        </dl>
      </li>
      <!-- 6. Khách hàng -->
      <li class="layui-nav-item">
        <a href="javascript:;">
          <i class="layui-icon layui-icon-survey" style="margin-right: 6px;"></i><span>Khách hàng</span>
        </a>
        <dl class="layui-nav-child">
          <dd>
            <a href="javascript:;" data-url="/pages/agent/editPassword.html" data-title="Đổi MK đăng nhập">Đổi MK đăng nhập</a>
          </dd>
          <dd>
            <a href="javascript:;" data-url="/pages/agent/editFundPassword.html" data-title="Đổi MK giao dịch">Đổi MK giao dịch</a>
          </dd>
        </dl>
      </li>
      <!-- 7. Tỉ lệ hoàn trả -->
      <li class="layui-nav-item">
        <a href="javascript:;">
          <i class="layui-icon layui-icon-list" style="margin-right: 6px;"></i><span>Tỉ lệ hoàn trả</span>
        </a>
        <dl class="layui-nav-child">
          <dd>
            <a href="javascript:;" data-url="/pages/agent/getRebateOddsPanel.html" data-title="Tỉ lệ hoàn trả">Tỉ lệ hoàn trả</a>
          </dd>
        </dl>
      </li>
      <!-- 8. Quản lý (admin only) -->
      <li class="layui-nav-item" id="menuManage" style="display:none;">
        <a href="javascript:;">
          <i class="layui-icon layui-icon-set" style="margin-right: 6px;"></i><span>Quản lý</span>
        </a>
        <dl class="layui-nav-child">
          <dd>
            <a href="javascript:;" data-url="/pages/manage/manageAgents.html" data-title="Quản lý Agents">Quản lý Agents</a>
          </dd>
          <dd>
            <a href="javascript:;" data-url="/pages/manage/manageUsers.html" data-title="Quản lý Users">Quản lý Users</a>
          </dd>
        </dl>
      </li>
    </ul>
  </div>

  <!-- Body -->
  <div class="hub-body">
    <div class="layui-tabs layui-hide-v" id="hubTabs" lay-options="{closable: true, headerMode: 'scroll'}">
      <ul class="layui-tabs-header"></ul>
      <div class="layui-tabs-body"></div>
    </div>
  </div>

  <script src="/lib/layui/layui.js"></script>
  <script src="/js/hub-api.js"></script>
  <script>
    // ── Auth guard ──
    if (!HubAPI.isLoggedIn()) {
      window.location.href = '/pages/login.html';
    }

    layui.use(['element', 'tabs', 'dropdown', 'layer'], function () {
      var $ = layui.$;
      var element = layui.element;
      var tabs = layui.tabs;
      var dropdown = layui.dropdown;
      var openedTabs = {};
      var TABS_ID = 'hubTabs';

      // ── Hiển thị user info ──
      var user = HubAPI.getUser();
      if (user) {
        document.getElementById('userInfo').textContent = user.username;

        // Hiện menu Quản lý nếu admin
        if (user.role === 'admin') {
          document.getElementById('menuManage').style.display = '';
        }
      }

      // ── Header nav "Tài khoản" ──
      element.on('nav(hub-account)', function (elem) {
        if (elem.attr('id') === 'navLogout') {
          HubAPI.logout();
          return;
        }
        var url = elem.attr('data-url');
        var title = elem.attr('data-title');
        if (!url) return;
        if (openedTabs[url]) {
          tabs.change(TABS_ID, url);
        } else {
          tabs.add(TABS_ID, {
            title: title,
            content: '<iframe src="' + url + '"></iframe>',
            id: url,
            done: function (data) {
              dropdown.render($.extend({}, dropdownInst.config, { elem: data.headerItem }));
            }
          });
          openedTabs[url] = true;
        }
        document.title = 'Agent Hub — ' + (title || '');
      });

      // ── Right-click context menu cho tab header ──
      var dropdownInst = dropdown.render({
        elem: '#' + TABS_ID + ' .layui-tabs-header>li',
        trigger: 'contextmenu',
        data: [
          { title: 'Đóng', action: 'close', mode: 'this' },
          { title: 'Đóng tab khác', action: 'close', mode: 'other' },
          { title: 'Đóng tab bên phải', action: 'close', mode: 'right' },
          { type: '-' },
          { title: 'Đóng tất cả', action: 'close', mode: 'all' }
        ],
        click: function (data) {
          var index = this.elem.index();
          if (data.mode === 'this') {
            tabs.close(TABS_ID, index);
          } else {
            tabs.closeMult(TABS_ID, data.mode, index);
          }
        }
      });

      // ── Click menu → mở tab hoặc chuyển sang tab đã mở ──
      element.on('nav(hub-menu)', function (elem) {
        var url = elem.attr('data-url');
        var title = elem.attr('data-title');
        if (!url) return;

        if (openedTabs[url]) {
          tabs.change(TABS_ID, url);
        } else {
          tabs.add(TABS_ID, {
            title: title,
            content: '<iframe src="' + url + '"></iframe>',
            id: url,
            done: function (data) {
              // Thêm context menu cho tab mới
              dropdown.render($.extend({}, dropdownInst.config, {
                elem: data.headerItem
              }));
            }
          });
          openedTabs[url] = true;
        }

        document.title = 'Agent Hub — ' + (title || '');
      });

      // ── Xoá tab → dọn dẹp openedTabs ──
      tabs.on('close(' + TABS_ID + ')', function (data) {
        var id = data.id;
        if (id) delete openedTabs[id];
      });

      // ── Toggle sidebar ──
      var toggleIcon = document.querySelector('#btnToggle .layui-icon');
      document.getElementById('btnToggle').addEventListener('click', function () {
        var collapsed = document.body.classList.toggle('hub-collapsed');
        if (collapsed) {
          toggleIcon.className = 'layui-icon layui-icon-spread-left';
          document.querySelectorAll('.hub-sidebar .layui-nav-itemed').forEach(function (el) { el.classList.remove('layui-nav-itemed'); });
        } else {
          toggleIcon.className = 'layui-icon layui-icon-shrink-right';
        }
      });

      // ── Refresh tab hiện tại ──
      document.getElementById('btnRefresh').addEventListener('click', function () {
        var active = document.querySelector('.hub-body .layui-tabs-item.layui-show iframe');
        if (active) active.contentWindow.location.reload();
      });

      // ── Fullscreen ──
      var fsIcon = document.querySelector('#btnFullscreen .layui-icon');
      document.getElementById('btnFullscreen').addEventListener('click', function () {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
          fsIcon.className = 'layui-icon layui-icon-screen-restore';
        } else {
          document.exitFullscreen();
          fsIcon.className = 'layui-icon layui-icon-screen-full';
        }
      });

      // ── More options (menu right) ──
      var layer = layui.layer;
      document.getElementById('btnMore').addEventListener('click', function () {
        layer.open({
          type: 1,
          title: 'Tuỳ chọn',
          content: '<div style="padding: 15px;">'
            + '<p>Chưa có tuỳ chọn nào.</p>'
            + '</div>',
          area: ['260px', '100%'],
          offset: 'rt',
          anim: 'slideLeft',
          shadeClose: true,
          scrollbar: false
        });
      });

      // Auto-load trang đầu tiên
      var firstLink = document.querySelector('.hub-sidebar .layui-this a[data-url]');
      if (firstLink) firstLink.click();
    });
  </script>
</body>
</html>
