<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Quản lý Agents EE88</title>
  <link rel="stylesheet" href="/lib/layui/css/layui.css">
  <style>
    body { margin: 0; padding: 0; background: #f2f2f2; font-family: sans-serif; }
    .layui-card { margin: 15px; }
    .status-active { color: #16b777; font-weight: 600; }
    .status-inactive { color: #ff5722; font-weight: 600; }
  </style>
</head>
<body>

  <!-- Toolbar -->
  <script type="text/html" id="toolbarTpl">
    <div class="layui-btn-group">
      <button class="layui-btn layui-btn-xs" lay-event="addAgent">
        <i class="layui-icon layui-icon-addition"></i> Thêm Agent
      </button>
      <button class="layui-btn layui-btn-xs layui-btn-normal" lay-event="checkAll">
        <i class="layui-icon layui-icon-refresh"></i> Kiểm tra tất cả
      </button>
    </div>
  </script>

  <!-- Row actions -->
  <script type="text/html" id="rowActionTpl">
    <button class="layui-btn layui-btn-xs" lay-event="edit">Sửa</button>
    <button class="layui-btn layui-btn-xs layui-btn-normal" lay-event="check">Kiểm tra</button>
    <button class="layui-btn layui-btn-xs layui-btn-danger" lay-event="delete">Xoá</button>
  </script>

  <!-- Status template -->
  <script type="text/html" id="statusTpl">
    {{# if(d.status === 1){ }}
      <span class="status-active">Hoạt động</span>
    {{# } else { }}
      <span class="status-inactive">Ngừng</span>
    {{# } }}
  </script>

  <div class="layui-row">
    <div class="layui-col-md12">
      <div class="layui-card">
        <div class="layui-card-header">
          <fieldset class="layui-elem-field">
            <legend>Quản lý tài khoản Agent EE88</legend>
          </fieldset>
        </div>
        <div class="layui-card-body">
          <table id="dataTable" lay-filter="dataTable"></table>
        </div>
      </div>
    </div>
  </div>

  <script src="/lib/layui/layui.js"></script>
  <script src="/js/hub-api.js"></script>
  <script>
    layui.use(['table', 'form', 'layer'], function () {
      var table = layui.table;
      var form = layui.form;
      var layer = layui.layer;
      var $ = layui.$;

      function loadAgents() {
        var loadIdx = layer.load();
        HubAPI.adminGet('agents').then(function (res) {
          layer.close(loadIdx);
          if (res.code === 0) {
            table.render({
              elem: '#dataTable',
              toolbar: '#toolbarTpl',
              defaultToolbar: ['filter'],
              data: res.data,
              text: { none: 'Không có agent nào' },
              cols: [[
                { field: 'id', title: 'ID', width: 60 },
                { field: 'label', title: 'Tên agent', width: 150 },
                { field: 'base_url', title: 'URL', width: 250 },
                { field: 'cookie_preview', title: 'Cookie', width: 200 },
                { field: 'status', title: 'Trạng thái', width: 100, templet: '#statusTpl' },
                { field: 'user_count', title: 'Số users', width: 100 },
                { field: 'last_check', title: 'Kiểm tra lần cuối', width: 160 },
                { field: 'created_at', title: 'Ngày tạo', width: 160 },
                { fixed: 'right', title: 'Thao tác', width: 220, toolbar: '#rowActionTpl' }
              ]]
            });
          } else {
            layer.msg(res.msg || 'Lỗi', { icon: 2 });
          }
        }).catch(function () {
          layer.close(loadIdx);
          layer.msg('Lỗi kết nối', { icon: 2 });
        });
      }

      loadAgents();

      // Toolbar events
      table.on('toolbar(dataTable)', function (obj) {
        if (obj.event === 'addAgent') {
          openAgentForm();
        } else if (obj.event === 'checkAll') {
          checkAllAgents();
        }
      });

      // Row events
      table.on('tool(dataTable)', function (obj) {
        var d = obj.data;
        switch (obj.event) {
          case 'edit':
            openAgentForm(d);
            break;
          case 'check':
            checkAgent(d.id);
            break;
          case 'delete':
            layer.confirm('Xác nhận xoá agent "' + d.label + '"?', { icon: 3 }, function (idx) {
              layer.close(idx);
              var loadIdx = layer.load();
              HubAPI.adminRequest('agents/' + d.id, 'DELETE').then(function (res) {
                layer.close(loadIdx);
                if (res.code === 0) {
                  layer.msg('Đã xoá', { icon: 1 });
                  loadAgents();
                } else {
                  layer.msg(res.msg || 'Thất bại', { icon: 2 });
                }
              }).catch(function () {
                layer.close(loadIdx);
                layer.msg('Lỗi kết nối', { icon: 2 });
              });
            });
            break;
        }
      });

      // Form thêm/sửa agent
      function openAgentForm(data) {
        var isEdit = !!data;
        var title = isEdit ? 'Sửa agent: ' + data.label : 'Thêm Agent mới';

        var html = '<form class="layui-form" lay-filter="agentForm" style="padding:15px 30px 0 0;">'
          + '<div class="layui-form-item">'
          + '<label class="layui-form-label">Tên agent</label>'
          + '<div class="layui-input-block">'
          + '<input type="text" name="label" value="' + (isEdit ? (data.label || '') : '') + '" placeholder="VD: Agent 1" class="layui-input" lay-verify="required">'
          + '</div></div>'
          + '<div class="layui-form-item">'
          + '<label class="layui-form-label">Base URL</label>'
          + '<div class="layui-input-block">'
          + '<input type="text" name="base_url" value="' + (isEdit ? (data.base_url || '') : '') + '" placeholder="https://xxx.ee88dly.com" class="layui-input" lay-verify="required">'
          + '</div></div>'
          + '<div class="layui-form-item">'
          + '<label class="layui-form-label">Cookie</label>'
          + '<div class="layui-input-block">'
          + '<textarea name="cookie" placeholder="PHPSESSID=xxx; cf_clearance=xxx" class="layui-textarea" lay-verify="required" style="height:80px;">' + (isEdit ? (data.cookie || '') : '') + '</textarea>'
          + '</div></div>';

        if (isEdit) {
          html += '<div class="layui-form-item">'
            + '<label class="layui-form-label">Trạng thái</label>'
            + '<div class="layui-input-block">'
            + '<select name="status">'
            + '<option value="1"' + (data.status === 1 ? ' selected' : '') + '>Hoạt động</option>'
            + '<option value="0"' + (data.status === 0 ? ' selected' : '') + '>Ngừng</option>'
            + '</select>'
            + '</div></div>';
        }

        html += '<div class="layui-form-item">'
          + '<div class="layui-input-block">'
          + '<button type="button" class="layui-btn" lay-submit lay-filter="submitAgent">Xác nhận</button>'
          + '<button type="reset" class="layui-btn layui-btn-primary">Đặt lại</button>'
          + '</div></div></form>';

        var layerIdx = layer.open({
          type: 1, title: title,
          area: ['550px', 'auto'],
          content: html,
          success: function () { form.render(); }
        });

        form.on('submit(submitAgent)', function (formData) {
          var body = {
            label: formData.field.label,
            base_url: formData.field.base_url,
            cookie: formData.field.cookie
          };
          if (isEdit) {
            body.status = parseInt(formData.field.status);
          }

          var loadIdx = layer.load();
          var url = isEdit ? 'agents/' + data.id : 'agents';
          var method = isEdit ? 'PUT' : 'POST';

          HubAPI.adminRequest(url, method, body).then(function (res) {
            layer.close(loadIdx);
            if (res.code === 0) {
              layer.close(layerIdx);
              layer.msg(isEdit ? 'Đã cập nhật' : 'Đã thêm agent', { icon: 1 });
              loadAgents();
            } else {
              layer.msg(res.msg || 'Thất bại', { icon: 2 });
            }
          }).catch(function () {
            layer.close(loadIdx);
            layer.msg('Lỗi kết nối', { icon: 2 });
          });
          return false;
        });
      }

      // Kiểm tra 1 agent
      function checkAgent(id) {
        var loadIdx = layer.load();
        HubAPI.adminRequest('agents/' + id + '/check', 'POST').then(function (res) {
          layer.close(loadIdx);
          if (res.code === 0) {
            layer.msg('Agent hoạt động bình thường', { icon: 1 });
          } else {
            layer.msg(res.msg || 'Agent có vấn đề', { icon: 2 });
          }
          loadAgents();
        }).catch(function () {
          layer.close(loadIdx);
          layer.msg('Lỗi kết nối', { icon: 2 });
        });
      }

      // Kiểm tra tất cả agents
      function checkAllAgents() {
        var loadIdx = layer.load();
        HubAPI.adminGet('agents').then(function (res) {
          if (res.code !== 0 || !res.data) {
            layer.close(loadIdx);
            return layer.msg('Lỗi', { icon: 2 });
          }
          var agents = res.data;
          var checked = 0;
          var results = [];

          agents.forEach(function (agent) {
            HubAPI.adminRequest('agents/' + agent.id + '/check', 'POST').then(function (r) {
              results.push({ label: agent.label, ok: r.code === 0 });
            }).catch(function () {
              results.push({ label: agent.label, ok: false });
            }).finally(function () {
              checked++;
              if (checked === agents.length) {
                layer.close(loadIdx);
                var ok = results.filter(function (r) { return r.ok; }).length;
                layer.msg(ok + '/' + agents.length + ' agent hoạt động', { icon: ok === agents.length ? 1 : 0 });
                loadAgents();
              }
            });
          });
        }).catch(function () {
          layer.close(loadIdx);
          layer.msg('Lỗi kết nối', { icon: 2 });
        });
      }
    });
  </script>
</body>
</html>
