<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sync Status</title>
    <link rel="stylesheet" href="/lib/layui/css/layui.css" />
    <link rel="stylesheet" href="/css/hub-icons.css" />
    <style>
      body {
        margin: 0;
        padding: 0;
        background: #f2f2f2;
        font-family: sans-serif;
      }
      .layui-card {
        margin: 15px;
        box-shadow:
          0 1px 4px rgba(0, 0, 0, 0.08),
          0 2px 8px rgba(0, 0, 0, 0.04);
        border-radius: 4px;
      }
      .layui-card-header {
        padding-bottom: 0;
        border-bottom: none;
      }
      .layui-elem-field {
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
        border-radius: 4px;
        border-color: #e6e6e6;
      }
      .layui-table-view {
        box-shadow:
          0 1px 4px rgba(0, 0, 0, 0.08),
          0 2px 8px rgba(0, 0, 0, 0.04);
        border-radius: 4px;
      }
      .layui-table-cell {
        text-align: left;
      }
      .layui-field-box .layui-inline {
        margin-bottom: 8px;
      }
      .layui-field-box .layui-inline label {
        font-size: 13px;
        margin-right: 5px;
      }
      .db-kpi-row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }
      .db-kpi-card {
        flex: 1;
        min-width: 155px;
        background: #fff;
        border-radius: 8px;
        padding: 16px;
        box-shadow:
          0 1px 4px rgba(0, 0, 0, 0.06),
          0 0 0 1px rgba(0, 0, 0, 0.03);
        display: flex;
        align-items: center;
        gap: 14px;
        transition:
          box-shadow 0.2s,
          transform 0.2s;
        border-left: 3px solid transparent;
      }
      .db-kpi-card:hover {
        box-shadow:
          0 4px 12px rgba(0, 0, 0, 0.1),
          0 0 0 1px rgba(0, 0, 0, 0.04);
        transform: translateY(-1px);
      }
      .db-kpi-card[data-accent='blue'] {
        border-left-color: #1e9fff;
      }
      .db-kpi-card[data-accent='green'] {
        border-left-color: #16b777;
      }
      .db-kpi-card[data-accent='yellow'] {
        border-left-color: #ffb800;
      }
      .db-kpi-card[data-accent='red'] {
        border-left-color: #ff5722;
      }
      .db-kpi-icon {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: #fff;
        flex-shrink: 0;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      }
      .db-kpi-info {
        flex: 1;
        min-width: 0;
      }
      .db-kpi-value {
        font-size: 22px;
        font-weight: 700;
        line-height: 1.2;
      }
      .db-kpi-label {
        font-size: 12px;
        color: #999;
        margin-top: 2px;
      }
      .page-info {
        font-size: 11px;
        color: #1e9fff;
        margin-left: 4px;
      }
      .error-text {
        font-size: 11px;
        color: #ff5722;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .syncing-spin {
        display: inline-block;
        animation: spin 1s linear infinite;
      }
    </style>
  </head>
  <body>
    <!-- Row action template -->
    <script type="text/html" id="toolbarTpl">
      {{# if(d.isAgent){ }}
      <div class="layui-btn-group">
        <button
          class="layui-btn layui-btn-xs layui-btn-normal"
          lay-event="sync"
        >
          <i class="hi hi-arrows-rotate"></i>
          <span data-i18n="syncBtn">Đồng bộ</span>
        </button>
        <button
          class="layui-btn layui-btn-xs layui-btn-danger"
          lay-event="clear"
        >
          <i class="hi hi-trash-can"></i>
          <span data-i18n="clearLocksBtn">Xoá khoá</span>
        </button>
      </div>
      {{# } }}
    </script>

    <div class="layui-row">
      <div class="layui-col-md12">
        <div class="layui-card">
          <div class="layui-form layui-card-header">
            <fieldset class="layui-elem-field">
              <legend data-i18n="syncDataTitle">Đồng bộ dữ liệu</legend>
              <div class="layui-field-box">
                <div class="db-kpi-row" id="statsArea">
                  <div class="db-kpi-card" data-accent="blue">
                    <div class="db-kpi-icon" style="background: #1e9fff">
                      <i class="hi hi-users"></i>
                    </div>
                    <div class="db-kpi-info">
                      <div class="db-kpi-value" id="statTotalAgents">
                        &mdash;
                      </div>
                      <div class="db-kpi-label" data-i18n="totalAgents">
                        Tổng Đại lý
                      </div>
                    </div>
                  </div>
                  <div class="db-kpi-card" data-accent="green">
                    <div class="db-kpi-icon" style="background: #16b777">
                      <i class="hi hi-circle-check"></i>
                    </div>
                    <div class="db-kpi-info">
                      <div class="db-kpi-value" id="statActiveAgents">
                        &mdash;
                      </div>
                      <div class="db-kpi-label" data-i18n="active">
                        Hoạt động
                      </div>
                    </div>
                  </div>
                  <div class="db-kpi-card" data-accent="yellow">
                    <div class="db-kpi-icon" style="background: #ffb800">
                      <i class="hi hi-arrows-rotate"></i>
                    </div>
                    <div class="db-kpi-info">
                      <div class="db-kpi-value" id="statFullySynced">
                        &mdash;
                      </div>
                      <div class="db-kpi-label" data-i18n="fullySynced">
                        Đã đồng bộ đủ
                      </div>
                    </div>
                  </div>
                  <div class="db-kpi-card" data-accent="red">
                    <div class="db-kpi-icon" style="background: #ff5722">
                      <i class="hi hi-signal"></i>
                    </div>
                    <div class="db-kpi-info">
                      <div
                        class="db-kpi-value"
                        id="statSyncState"
                        style="font-size: 14px"
                      >
                        &mdash;
                      </div>
                      <div class="db-kpi-label" data-i18n="status">
                        Trạng thái
                      </div>
                    </div>
                  </div>
                </div>
                <form class="layui-form" lay-filter="searchForm">
                  <div class="layui-inline">
                    <label data-i18n="agent">Đại lý</label>：
                    <div class="layui-input-inline" style="width: 150px">
                      <select name="agent_id" id="filterAgent">
                        <option value="" data-i18n="all">Tất cả</option>
                      </select>
                    </div>
                  </div>
                  <div class="layui-inline">
                    <label>Endpoint</label>：
                    <div class="layui-input-inline" style="width: 180px">
                      <select name="endpoint" id="filterEndpoint">
                        <option value="" data-i18n="all">Tất cả</option>
                      </select>
                    </div>
                  </div>
                  <div class="layui-inline">
                    <label data-i18n="status">Trạng thái</label>：
                    <div class="layui-input-inline" style="width: 140px">
                      <select name="status">
                        <option value="" data-i18n="all">Tất cả</option>
                        <option value="done" data-i18n="completed">
                          Hoàn tất
                        </option>
                        <option value="syncing" data-i18n="syncRunning">
                          Đang chạy
                        </option>
                        <option value="idle" data-i18n="notSynced">
                          Chưa đồng bộ
                        </option>
                        <option value="error" data-i18n="error">Lỗi</option>
                      </select>
                    </div>
                  </div>
                  <div class="layui-inline">
                    <button
                      type="button"
                      class="layui-btn"
                      lay-submit
                      lay-filter="doSearch"
                    >
                      <i class="hi hi-magnifying-glass"></i>
                      <span data-i18n="search">Tìm</span>
                    </button>
                  </div>
                  <div class="layui-inline">
                    <button
                      type="reset"
                      class="layui-btn layui-btn-primary"
                      id="btnReset"
                    >
                      <i class="hi hi-arrows-rotate"></i>
                      <span data-i18n="reset">Đặt lại</span>
                    </button>
                  </div>
                </form>
              </div>
            </fieldset>
          </div>
          <div class="layui-card-body">
            <table
              class="layui-hide"
              id="syncTree"
              lay-filter="syncTree"
            ></table>
          </div>
        </div>
      </div>
    </div>

    <script src="/lib/layui/layui.js"></script>
    <script src="/js/hub-utils.js"></script>
    <script src="/js/hub-lang.js"></script>
    <script src="/js/hub-crypto.js?v=3"></script>
    <script src="/js/hub-api.js?v=3"></script>

    <script>
      layui.use(['treeTable', 'form', 'layer'], function () {
        HubLang.init();
        HubLang.applyDOM();
        document.title = HubLang.t('syncStatusTitle');
        var treeTable = layui.treeTable;
        var form = layui.form;
        var layer = layui.layer;
        var $ = layui.$;

        var agents = [];
        var snap = null;
        var rendered = false;
        var currentFilter = {};
        var sse = null;
        var pollTimer = null;
        var statsTimer = null;
        var sseRetryCount = 0;
        var MAX_SSE_RETRIES = 3;
        var totalDays = 65;
        var sseIdleTimer = null;
        var lastTreeData = null;
        var updateTimer = null;

        // ═══════════════════════════════════════
        // ── Static endpoint list — phải KHỚP thứ tự server ALL_EPS ──
        // ═══════════════════════════════════════

        var STATIC_EPS = [
          { key: 'members', name: HubLang.t('epMembers'), isDate: false },
          { key: 'invites', name: HubLang.t('epInvites'), isDate: false },
          { key: 'bet-orders', name: HubLang.t('epBetOrders'), isDate: false },
          { key: 'deposits', name: HubLang.t('epDeposits'), isDate: true },
          {
            key: 'withdrawals',
            name: HubLang.t('epWithdrawals'),
            isDate: true
          },
          {
            key: 'lottery-bets',
            name: HubLang.t('epLotteryBets'),
            isDate: true
          },
          {
            key: 'report-lottery',
            name: HubLang.t('epReportLottery'),
            isDate: true
          },
          {
            key: 'report-funds',
            name: HubLang.t('epReportFunds'),
            isDate: true
          },
          {
            key: 'report-third',
            name: HubLang.t('epReportThird'),
            isDate: true
          }
        ];

        // Populate endpoint filter dropdown
        var epSel = $('#filterEndpoint');
        STATIC_EPS.forEach(function (ep) {
          epSel.append(
            '<option value="' +
              HubUtils.escapeHtml(ep.key) +
              '">' +
              HubUtils.escapeHtml(ep.name) +
              '</option>'
          );
        });
        form.render('select');

        // ═══════════════════════════════════════
        // ── Helpers ──
        // ═══════════════════════════════════════

        function fmtElapsed(ms) {
          var s = Math.round(ms / 1000);
          if (s < 60) return s + 's';
          return (
            Math.floor(s / 60) + 'm' + String(s % 60).padStart(2, '0') + 's'
          );
        }

        function setNum(id, val) {
          var el = document.getElementById(id);
          if (el) el.textContent = val;
        }

        function fmtRows(n) {
          if (!n || n <= 0) return '\u2014';
          return n.toLocaleString();
        }

        // ═══════════════════════════════════════
        // ── Build tree data ──
        // ═══════════════════════════════════════

        function buildTreeData() {
          var snapMap = {};
          if (snap && snap.agents) {
            snap.agents.forEach(function (a) {
              snapMap[a.agentId] = a;
            });
          }

          return agents.map(function (a) {
            var pa = snapMap[a.id];
            // Dùng progress data khi CÓ (syncing/done/error) — không chỉ khi syncing
            var hasProgress = pa && pa.endpoints && pa.endpoints.length > 0;
            var isSyncing = pa && pa.status === 'syncing';

            var node = {
              id: a.id,
              name: a.label,
              isAgent: true,
              agentId: a.id,
              lockedDays: a.lockedDays || 0,
              lastSyncAt: a.lastSyncAt || null,
              agentStatus: a.status,
              syncing: isSyncing,
              syncStatus: pa ? pa.status : null,
              elapsed:
                isSyncing || (pa && pa.status === 'done') ? pa.elapsed || 0 : 0
            };

            if (hasProgress) {
              // Real-time data từ progress snapshot
              node.children = pa.endpoints.map(function (ep, idx) {
                return {
                  id: a.id * 1000 + idx + 1,
                  name: ep.name || ep.key,
                  epKey: ep.key,
                  isAgent: false,
                  total: ep.total,
                  completed: ep.completed,
                  dataRows: ep.rows || 0,
                  epStatus: ep.status,
                  currentPage: ep.currentPage || 0,
                  totalPages: ep.totalPages || 0,
                  error: ep.error || null
                };
              });
            } else {
              // Static data từ /status (hiện rows từ DB cho TẤT CẢ endpoints)
              var agentRows = a.rows || {};
              node.children = STATIC_EPS.map(function (ep, idx) {
                var total, completed, rows, status;
                rows = agentRows[ep.key] || 0;

                if (ep.isDate) {
                  total = totalDays;
                  completed = a.lockedDays || 0;
                  status = (a.lockedDays || 0) >= totalDays ? 'done' : 'idle';
                } else {
                  total = 1;
                  completed = rows > 0 ? 1 : 0;
                  status = rows > 0 ? 'done' : 'idle';
                }
                return {
                  id: a.id * 1000 + idx + 1,
                  name: ep.name,
                  epKey: ep.key,
                  isAgent: false,
                  total: total,
                  completed: completed,
                  dataRows: rows,
                  epStatus: status,
                  currentPage: 0,
                  totalPages: 0,
                  error: null
                };
              });
            }

            return node;
          });
        }

        // ═══════════════════════════════════════
        // ── Filter tree data ──
        // ═══════════════════════════════════════

        function filterTreeData(data) {
          if (
            !currentFilter.agent_id &&
            !currentFilter.endpoint &&
            !currentFilter.status
          ) {
            return data;
          }
          var result = [];
          data.forEach(function (agent) {
            if (
              currentFilter.agent_id &&
              String(agent.id) !== String(currentFilter.agent_id)
            )
              return;
            var children = agent.children || [];
            if (currentFilter.endpoint || currentFilter.status) {
              children = children.filter(function (c) {
                if (
                  currentFilter.endpoint &&
                  c.epKey !== currentFilter.endpoint
                )
                  return false;
                if (currentFilter.status && c.epStatus !== currentFilter.status)
                  return false;
                return true;
              });
              if (children.length === 0) return;
            }
            var cloned = {};
            for (var k in agent) {
              if (agent.hasOwnProperty(k)) cloned[k] = agent[k];
            }
            cloned.children = children;
            result.push(cloned);
          });
          return result;
        }

        // ═══════════════════════════════════════
        // ── Render tree ──
        // ═══════════════════════════════════════

        // ═══════════════════════════════════════
        // ── Column templet functions (reusable for direct DOM updates) ──
        // ═══════════════════════════════════════

        var colTemplets = {
          name: function (d) {
            if (d.isAgent) {
              var c = d.agentStatus === 1 ? '#16b777' : '#ff5722';
              var syncIcon = d.syncing
                ? ' <i class="hi hi-arrows-rotate syncing-spin" style="font-size:12px;color:#1e9fff;"></i>'
                : '';
              return (
                '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:' +
                c +
                ';margin-right:6px;vertical-align:middle;"></span><b>' +
                HubUtils.escapeHtml(d.name) +
                '</b>' +
                syncIcon
              );
            }
            return (
              '<span style="color:#1e9fff;">' +
              HubUtils.escapeHtml(d.name) +
              '</span>'
            );
          },
          status: function (d) {
            if (d.isAgent) {
              if (d.syncing)
                return (
                  '<span style="color:#1e9fff;font-weight:600;">' +
                  HubLang.t('syncRunning') +
                  '</span>'
                );
              if (d.syncStatus === 'done')
                return (
                  '<span style="color:#16b777;font-weight:600;">' +
                  HubLang.t('completed') +
                  '</span>'
                );
              if (d.syncStatus === 'error')
                return (
                  '<span style="color:#ff5722;font-weight:600;">' +
                  HubLang.t('error') +
                  '</span>'
                );
              return d.agentStatus === 1
                ? '<span style="color:#16b777;font-weight:600;">' +
                    HubLang.t('active') +
                    '</span>'
                : '<span style="color:#ff5722;font-weight:600;">' +
                    HubLang.t('locked') +
                    '</span>';
            }
            if (d.epStatus === 'done')
              return (
                '<span style="color:#16b777;font-weight:600;">' +
                HubLang.t('completed') +
                '</span>'
              );
            if (d.epStatus === 'error')
              return (
                '<span style="color:#ff5722;font-weight:600;">' +
                HubLang.t('error') +
                '</span>'
              );
            if (d.epStatus === 'syncing')
              return (
                '<span style="color:#1e9fff;font-weight:600;">' +
                HubLang.t('syncRunning') +
                '</span>'
              );
            if (d.epStatus === 'pending')
              return (
                '<span style="color:#999;">' + HubLang.t('pending') + '</span>'
              );
            return '<span style="color:#666;">\u2014</span>';
          },
          syncProgress: function (d) {
            var completed, total, color;
            if (d.isAgent) {
              if (d.syncing && d.children) {
                completed = 0;
                total = 0;
                for (var ci = 0; ci < d.children.length; ci++) {
                  completed += d.children[ci].completed || 0;
                  total += d.children[ci].total || 0;
                }
              } else {
                completed = d.lockedDays;
                total = totalDays;
              }
            } else {
              completed = d.completed || 0;
              total = d.total || 0;
            }
            var pct = total > 0 ? Math.round((completed / total) * 100) : 0;
            if (pct > 100) pct = 100;
            if (d.isAgent) {
              color =
                pct >= 100 ? '#16b777' : pct >= 50 ? '#ffb800' : '#ff5722';
            } else {
              color =
                d.epStatus === 'done'
                  ? '#16b777'
                  : d.epStatus === 'error'
                    ? '#ff5722'
                    : d.epStatus === 'idle'
                      ? '#999'
                      : '#1e9fff';
            }

            var html =
              '<div style="display:flex;align-items:center;gap:8px;">' +
              '<div style="flex:1;height:6px;background:rgba(0,0,0,0.06);border-radius:3px;overflow:hidden;">' +
              '<div style="width:' +
              pct +
              '%;height:100%;background:' +
              color +
              ';border-radius:3px;transition:width .3s;"></div></div>' +
              '<span style="font-size:12px;color:' +
              color +
              ';font-weight:600;white-space:nowrap;">' +
              completed +
              '/' +
              total +
              '</span>';

            if (!d.isAgent && d.totalPages > 1 && d.epStatus === 'syncing') {
              html +=
                '<span class="page-info">p' +
                d.currentPage +
                '/' +
                d.totalPages +
                '</span>';
            }

            html += '</div>';

            if (!d.isAgent && d.error) {
              html +=
                '<div class="error-text" title="' +
                d.error.replace(/"/g, '&quot;') +
                '">' +
                d.error +
                '</div>';
            }

            return html;
          },
          dataRows: function (d) {
            if (d.isAgent) {
              var totalRows = 0;
              if (d.children) {
                for (var i = 0; i < d.children.length; i++) {
                  totalRows += d.children[i].dataRows || 0;
                }
              }
              return totalRows > 0
                ? '<span style="font-weight:600;color:#1e9fff;">' +
                    totalRows.toLocaleString() +
                    '</span>'
                : '<span style="color:#999;">\u2014</span>';
            }
            return d.dataRows > 0
              ? '<span style="font-weight:600;">' +
                  d.dataRows.toLocaleString() +
                  '</span>'
              : '<span style="color:#999;">\u2014</span>';
          },
          lockedDays: function (d) {
            if (d.isAgent) {
              var ld = d.lockedDays || 0;
              if (ld > 0)
                return (
                  '<span style="color:#ffb800;"><i class="hi hi-lock" style="font-size:14px;"></i> ' +
                  ld +
                  '</span>'
                );
              return '<span style="color:#999;">0</span>';
            }
            return '';
          },
          time: function (d) {
            if (!d.isAgent) return '';
            if (d.syncing && d.elapsed) {
              return (
                '<span style="font-size:12px;color:#1e9fff;"><i class="hi hi-arrows-rotate syncing-spin" style="font-size:11px;"></i> ' +
                fmtElapsed(d.elapsed) +
                '</span>'
              );
            }
            if (d.lastSyncAt) {
              var t = d.lastSyncAt.replace('T', ' ').substring(0, 16);
              return (
                '<span style="font-size:11px;color:#999;">' + t + '</span>'
              );
            }
            return '<span style="color:#666;">\u2014</span>';
          }
        };

        var barToolbarHtml =
          '<div class="layui-btn-group">' +
          '<button class="layui-btn layui-btn-xs layui-btn-normal" lay-event="syncAll">' +
          '<i class="hi hi-arrows-rotate"></i> ' +
          HubLang.t('syncAllBtn') +
          '</button>' +
          '<button class="layui-btn layui-btn-xs layui-btn-danger" lay-event="clearSelected">' +
          '<i class="hi hi-trash-can"></i> ' +
          HubLang.t('clearSelectedBtn') +
          '</button>' +
          '</div><span id="syncingIndicator"></span>';

        function renderTree() {
          var data = filterTreeData(buildTreeData());
          if (!rendered) {
            treeTable.render({
              id: 'syncTree',
              elem: '#syncTree',
              toolbar: barToolbarHtml,
              defaultToolbar: ['filter', 'print', 'exports'],
              data: data,
              tree: {
                customName: { children: 'children' },
                view: { showIcon: false }
              },
              size: 'sm',
              even: true,
              cols: [
                [
                  { type: 'checkbox', width: 50 },
                  {
                    field: 'name',
                    title: HubLang.t('agentDataType'),
                    minWidth: 150,
                    templet: colTemplets.name
                  },
                  {
                    title: HubLang.t('status'),
                    width: 100,
                    align: 'center',
                    templet: colTemplets.status
                  },
                  {
                    title: HubLang.t('syncProgress'),
                    minWidth: 160,
                    templet: colTemplets.syncProgress
                  },
                  {
                    title: HubLang.t('dataRows'),
                    width: 90,
                    align: 'right',
                    templet: colTemplets.dataRows
                  },
                  {
                    title: HubLang.t('lockedDaysCol'),
                    width: 80,
                    align: 'center',
                    templet: colTemplets.lockedDays
                  },
                  {
                    title: HubLang.t('time'),
                    width: 130,
                    align: 'center',
                    templet: colTemplets.time
                  },
                  {
                    title: HubLang.t('actions'),
                    width: 160,
                    align: 'center',
                    toolbar: '#toolbarTpl'
                  }
                ]
              ],
              done: function () {
                HubLang.applyDOM();
              }
            });
            rendered = true;
          } else {
            treeTable.reloadData('syncTree', { data: data });
          }
        }

        // ═══════════════════════════════════════
        // ── Direct DOM cell update (preserves expand state) ──
        // ═══════════════════════════════════════

        function updateTreeCells() {
          var data = filterTreeData(buildTreeData());

          if (!rendered) {
            renderTree();
            lastTreeData = data;
            return;
          }

          // Nếu structure thay đổi (số agents, số children) → reloadData
          if (isStructureChanged(data, lastTreeData)) {
            treeTable.reloadData('syncTree', { data: data });
            lastTreeData = data;
            return;
          }

          // Direct DOM update — chỉ thay đổi nội dung cells
          var tableView = $('#syncTree').next('.layui-table-view');
          data.forEach(function (agent, ai) {
            updateRowCells(tableView, String(ai), agent);
            if (agent.children) {
              agent.children.forEach(function (ep, ei) {
                updateRowCells(tableView, ai + '-' + ei, ep);
              });
            }
          });
          lastTreeData = data;
        }

        function isStructureChanged(newData, oldData) {
          if (!oldData) return true;
          if (newData.length !== oldData.length) return true;
          for (var i = 0; i < newData.length; i++) {
            if (newData[i].id !== oldData[i].id) return true;
            var nc = newData[i].children || [];
            var oc = oldData[i].children || [];
            if (nc.length !== oc.length) return true;
          }
          return false;
        }

        function updateRowCells(tableView, dataIndex, d) {
          var row = tableView.find(
            '.layui-table-main tr[data-index="' + dataIndex + '"]'
          );
          if (row.length === 0) return;

          // Column indices: 0=checkbox, 1=name, 2=status, 3=progress,
          //                 4=dataRows, 5=lockedDays, 6=time, 7=actions
          function cellAt(idx) {
            return row.find('td:eq(' + idx + ') .layui-table-cell');
          }

          // Cột name: Layui treeTable thêm icon expand (.layui-table-tree-flexIcon)
          // bên cạnh .layui-table-tree-item. Chỉ update nội dung trong tree-item
          // để giữ nguyên icon expand/collapse
          var nameCell = cellAt(1);
          if (nameCell.length) {
            var treeItem = nameCell.find('.layui-table-tree-item');
            if (treeItem.length) {
              treeItem.html(colTemplets.name(d));
            }
          }

          // Các cột khác: không có tree icon, update trực tiếp
          var statusCell = cellAt(2);
          var progressCell = cellAt(3);
          var dataRowsCell = cellAt(4);
          var timeCell = cellAt(6);

          if (statusCell.length) statusCell.html(colTemplets.status(d));
          if (progressCell.length)
            progressCell.html(colTemplets.syncProgress(d));
          if (dataRowsCell.length) dataRowsCell.html(colTemplets.dataRows(d));
          if (timeCell.length) timeCell.html(colTemplets.time(d));
        }

        // ═══════════════════════════════════════
        // ── SSE Real-time Progress ──
        // ═══════════════════════════════════════

        function connectSSE() {
          if (sse) return; // already connected
          var token = HubAPI.getToken();
          if (!token) return;

          stopPolling(); // Stop polling khi dùng SSE

          sse = new EventSource(
            '/api/admin/sync/progress?token=' + encodeURIComponent(token)
          );

          sse.onmessage = function (event) {
            try {
              // Reset retry count khi nhận được message thành công
              sseRetryCount = 0;
              var parsed = JSON.parse(event.data);
              if (
                typeof HubCrypto !== 'undefined' &&
                HubCrypto.isEncrypted(parsed)
              ) {
                HubCrypto.decrypt(parsed._enc).then(function (data) {
                  handleProgressData(data);
                });
              } else {
                handleProgressData(parsed);
              }
            } catch (e) {}
          };

          sse.onerror = function () {
            disconnectSSE();
            sseRetryCount++;
            if (sseRetryCount <= MAX_SSE_RETRIES) {
              // Retry SSE sau 3s
              setTimeout(connectSSE, 3000);
            } else {
              // Fallback to polling
              startPolling();
            }
          };
        }

        function disconnectSSE() {
          if (sse) {
            sse.close();
            sse = null;
          }
          clearTimeout(sseIdleTimer);
          sseIdleTimer = null;
        }

        // ═══════════════════════════════════════
        // ── Polling Fallback ──
        // ═══════════════════════════════════════

        function startPolling() {
          if (pollTimer || sse) return;
          pollTimer = setInterval(function () {
            HubAPI.adminGet('sync/progress-data')
              .then(function (res) {
                if (res.code === 0 && res.data) handleProgressData(res.data);
              })
              .catch(function (err) {
                console.warn('Poll progress lỗi:', err.message);
              });
          }, 2000);
        }

        function stopPolling() {
          if (pollTimer) {
            clearInterval(pollTimer);
            pollTimer = null;
          }
        }

        // ═══════════════════════════════════════
        // ── Handle progress data (từ SSE hoặc polling) ──
        // ═══════════════════════════════════════

        function handleProgressData(data) {
          if (data.agents && data.agents.length > 0) {
            snap = data;
            clearTimeout(sseIdleTimer);
            sseIdleTimer = null;
            var stillSyncing = data.agents.some(function (a) {
              return a.status === 'syncing';
            });
            updateSyncState(stillSyncing);
            // Throttle DOM updates (500ms)
            if (!updateTimer) {
              updateTreeCells();
              updateTimer = setTimeout(function () {
                updateTimer = null;
                if (snap) updateTreeCells();
              }, 500);
            }
            if (!stillSyncing) {
              // Tất cả agents done/error — đợi 5s rồi disconnect
              setTimeout(function () {
                snap = null;
                loadAgents();
                disconnectSSE();
                stopPolling();
              }, 5000);
            }
          } else {
            if (snap) {
              // Transition: sync vừa xong — refresh static data
              snap = null;
              loadAgents();
              disconnectSSE();
              stopPolling();
            }
            // Nếu snap === null: chưa có progress → giữ SSE, set idle timeout
            if (!sseIdleTimer && sse) {
              sseIdleTimer = setTimeout(function () {
                disconnectSSE();
                stopPolling();
              }, 30000);
            }
            updateSyncState(false);
          }
        }

        function updateSyncState(isSyncing) {
          var stateEl = document.getElementById('statSyncState');
          if (stateEl) {
            stateEl.textContent = isSyncing
              ? HubLang.t('syncRunning')
              : HubLang.t('ready');
            stateEl.style.color = isSyncing ? '#ff4d4f' : '#16b777';
          }
          var ind = document.getElementById('syncingIndicator');
          if (ind) {
            ind.innerHTML = isSyncing
              ? '<span class="layui-btn layui-btn-xs" style="background:#1e9fff;border-color:#1e9fff;cursor:default;margin-left:10px;">' +
                '<i class="hi hi-arrows-rotate syncing-spin"></i> ' +
                HubLang.t('syncingIndicator') +
                '</span>'
              : '';
          }
        }

        // ═══════════════════════════════════════
        // ── Events ──
        // ═══════════════════════════════════════

        // Table-level toolbar
        treeTable.on('toolbar(syncTree)', function (obj) {
          if (obj.event === 'syncAll') {
            layer.confirm(
              HubLang.t('confirmSyncAll'),
              { icon: 3 },
              function (idx) {
                layer.close(idx);
                var loadIdx = layer.load(2, { shade: [0.3, '#000'] });
                HubAPI.adminRequest('sync/run-all', 'POST', {})
                  .then(function (res) {
                    layer.close(loadIdx);
                    if (res.code === 0) {
                      layer.msg(HubLang.t('syncStarted'), { icon: 1 });
                      // Kết nối SSE ngay lập tức để nhận progress
                      setTimeout(connectSSE, 500);
                    } else {
                      layer.msg(res.msg || HubLang.t('error'), { icon: 2 });
                    }
                  })
                  .catch(function () {
                    layer.close(loadIdx);
                    layer.msg(HubLang.t('connectionError'), { icon: 2 });
                  });
              }
            );
          } else if (obj.event === 'clearSelected') {
            var checked = treeTable.checkStatus('syncTree');
            var selectedIds = [];
            if (checked && checked.data) {
              checked.data.forEach(function (row) {
                if (row.isAgent && row.id) selectedIds.push(row.id);
              });
            }
            if (selectedIds.length === 0) {
              layer.msg(HubLang.t('noSelection'), { icon: 0 });
              return;
            }
            layer.confirm(
              HubLang.t('confirmClearSelectedLocks') +
                ' ' +
                selectedIds.length +
                ' ' +
                HubLang.t('selectedAgents') +
                '?',
              { icon: 3 },
              function (idx) {
                layer.close(idx);
                var loadIdx = layer.load();
                var promises = selectedIds.map(function (aid) {
                  return HubAPI.adminRequest('sync/clear', 'POST', {
                    agent_id: aid
                  });
                });
                Promise.all(promises)
                  .then(function () {
                    layer.close(loadIdx);
                    layer.msg(HubLang.t('deleted'), { icon: 1 });
                    loadAgents();
                  })
                  .catch(function () {
                    layer.close(loadIdx);
                    layer.msg(HubLang.t('connectionError'), { icon: 2 });
                  });
              }
            );
          }
        });

        // Row-level tool
        treeTable.on('tool(syncTree)', function (obj) {
          var d = obj.data;
          if (!d.isAgent) return;

          if (obj.event === 'sync') {
            layer.confirm(
              HubLang.t('confirmSyncAgent') +
                ' "' +
                HubUtils.escapeHtml(d.name) +
                '"?',
              { icon: 3 },
              function (idx) {
                layer.close(idx);
                HubAPI.adminRequest('sync/run', 'POST', { agent_id: d.agentId })
                  .then(function (res) {
                    if (res.code === 0) {
                      layer.msg(HubLang.t('syncStarted'), { icon: 1 });
                      // Kết nối SSE ngay lập tức
                      setTimeout(connectSSE, 500);
                    } else {
                      layer.msg(res.msg || HubLang.t('error'), { icon: 2 });
                    }
                  })
                  .catch(function () {
                    layer.msg(HubLang.t('connectionError'), { icon: 2 });
                  });
              }
            );
          } else if (obj.event === 'clear') {
            layer.confirm(
              HubLang.t('confirmClearAgentLocks') +
                ' "' +
                HubUtils.escapeHtml(d.name) +
                '"?',
              { icon: 3 },
              function (idx) {
                layer.close(idx);
                HubAPI.adminRequest('sync/clear', 'POST', {
                  agent_id: d.agentId
                })
                  .then(function (res) {
                    if (res.code === 0) {
                      layer.msg(res.msg || HubLang.t('deleted'), { icon: 1 });
                      loadAgents();
                    } else {
                      layer.msg(res.msg || HubLang.t('error'), { icon: 2 });
                    }
                  })
                  .catch(function () {
                    layer.msg(HubLang.t('connectionError'), { icon: 2 });
                  });
              }
            );
          }
        });

        // Filter
        form.on('submit(doSearch)', function (data) {
          currentFilter = {};
          if (data.field.agent_id) currentFilter.agent_id = data.field.agent_id;
          if (data.field.endpoint) currentFilter.endpoint = data.field.endpoint;
          if (data.field.status) currentFilter.status = data.field.status;
          renderTree();
          return false;
        });

        document
          .getElementById('btnReset')
          .addEventListener('click', function () {
            currentFilter = {};
            setTimeout(function () {
              form.render('select');
              renderTree();
            }, 50);
          });

        // ═══════════════════════════════════════
        // ── Data loading ──
        // ═══════════════════════════════════════

        function loadAgents() {
          HubAPI.adminGet('sync/status')
            .then(function (res) {
              if (res.code !== 0) return;
              var d = res.data;
              agents = d.agents || [];
              totalDays = d.totalDays || 65;

              // Stat cards
              var active = agents.filter(function (a) {
                return a.status === 1;
              }).length;
              var full = agents.filter(function (a) {
                return (a.lockedDays || 0) >= totalDays;
              }).length;
              setNum('statTotalAgents', agents.length);
              setNum('statActiveAgents', active);
              setNum('statFullySynced', full + '/' + agents.length);

              // Nếu đang sync → kết nối SSE
              if (d.syncing) {
                connectSSE();
              }

              updateSyncState(d.syncing);
              // Khi SSE đang active (snap có data) → không reloadData
              // để tránh mất expand state; SSE sẽ cập nhật qua updateTreeCells
              if (!snap) {
                renderTree();
              }
            })
            .catch(function (err) {
              console.warn('loadAgents lỗi:', err.message);
            });
        }

        function loadAgentFilter() {
          HubAPI.adminGet('agents')
            .then(function (res) {
              if (res.code !== 0 || !res.data) return;
              var sel = $('#filterAgent');
              res.data.forEach(function (a) {
                sel.append(
                  '<option value="' +
                    a.id +
                    '">' +
                    HubUtils.escapeHtml(a.label) +
                    '</option>'
                );
              });
              form.render('select');
            })
            .catch(function () {});
        }

        // ── Init ──
        loadAgents();
        loadAgentFilter();
        // Refresh static data mỗi 30s
        statsTimer = setInterval(loadAgents, 30000);

        window.addEventListener('beforeunload', function () {
          disconnectSSE();
          stopPolling();
          if (statsTimer) clearInterval(statsTimer);
          clearTimeout(updateTimer);
        });
      });
    </script>
  </body>
</html>
