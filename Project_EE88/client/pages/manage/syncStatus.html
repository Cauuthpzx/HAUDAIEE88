<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sync Status</title>
  <link rel="stylesheet" href="/lib/layui/css/layui.css">
  <link rel="stylesheet" href="/css/hub-icons.css">
  <style>
    body { margin: 0; padding: 0; background: #f2f2f2; font-family: sans-serif; }
    .layui-card { margin: 15px; }
    .stat-cards { display: flex; gap: 15px; padding: 0 15px; flex-wrap: wrap; margin-top: 15px; }
    .stat-card {
      flex: 1; min-width: 160px; background: #fff; border-radius: 4px;
      padding: 15px 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    }
    .stat-card .label { font-size: 13px; color: #999; margin-bottom: 6px; }
    .stat-card .value { font-size: 22px; font-weight: 600; color: #333; }
    .stat-card .value.green { color: #16b777; }
    .stat-card .value.blue { color: #1e9fff; }
    .stat-card .value.orange { color: #ffb800; }
  </style>
</head>
<body>

  <!-- Row action template -->
  <script type="text/html" id="toolbarTpl">
    {{# if(d.isAgent){ }}
    <div class="layui-btn-group">
      <button class="layui-btn layui-btn-xs layui-btn-normal" lay-event="sync"><i class="hi hi-arrows-rotate"></i> Đồng bộ</button>
      <button class="layui-btn layui-btn-xs layui-btn-danger" lay-event="clear"><i class="hi hi-trash-can"></i> Xoá khoá</button>
    </div>
    {{# } }}
  </script>

  <!-- Stat Cards -->
  <div class="stat-cards" id="statsArea">
    <div class="stat-card">
      <div class="label">Tổng đại lý</div>
      <div class="value blue" id="statTotalAgents">—</div>
    </div>
    <div class="stat-card">
      <div class="label">Hoạt động</div>
      <div class="value green" id="statActiveAgents">—</div>
    </div>
    <div class="stat-card">
      <div class="label">Đã đồng bộ đủ</div>
      <div class="value orange" id="statFullySynced">—</div>
    </div>
    <div class="stat-card">
      <div class="label">Trạng thái</div>
      <div class="value" id="statSyncState" style="font-size:14px;">—</div>
    </div>
  </div>

  <!-- Table -->
  <div class="layui-row">
    <div class="layui-col-md12">
      <div class="layui-card">
        <div class="layui-card-header">
          <fieldset class="layui-elem-field">
            <legend>Đồng bộ dữ liệu</legend>
          </fieldset>
          <form class="layui-form layui-form-sm" lay-filter="searchForm" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
            <select name="agent_id" id="filterAgent" style="width:150px;">
              <option value="">Tất cả — Đại lý</option>
            </select>
            <select name="endpoint" id="filterEndpoint" style="width:180px;">
              <option value="">Tất cả — Endpoint</option>
            </select>
            <select name="status" style="width:140px;">
              <option value="">Tất cả — Trạng thái</option>
              <option value="done">Hoàn tất</option>
              <option value="syncing">Đang chạy</option>
              <option value="idle">Chưa đồng bộ</option>
              <option value="error">Lỗi</option>
            </select>
            <button type="button" class="layui-btn layui-btn-xs" lay-submit lay-filter="doSearch">
              <i class="layui-icon layui-icon-search"></i> Tìm kiếm
            </button>
            <button type="reset" class="layui-btn layui-btn-xs layui-btn-primary" id="btnReset">
              Đặt lại
            </button>
          </form>
        </div>
        <div class="layui-card-body">
          <table class="layui-hide" id="syncTree" lay-filter="syncTree"></table>
        </div>
      </div>
    </div>
  </div>

  <script src="/lib/layui/layui.js"></script>
  <script src="/js/hub-lang.js"></script>
  <script src="/js/hub-api.js"></script>
  <script>
    layui.use(['treeTable', 'form', 'layer'], function () {
      HubLang.init();
      var treeTable = layui.treeTable;
      var form = layui.form;
      var layer = layui.layer;
      var $ = layui.$;

      var pollTimer = null;
      var statsTimer = null;
      var agents = [];
      var snap = null;
      var rendered = false;
      var currentFilter = {};

      // Static endpoint list (matching server/config/endpoints.js)
      var STATIC_EPS = [
        { key: 'members', name: 'Danh sách hội viên', isDate: false },
        { key: 'invites', name: 'Mã mời', isDate: false },
        { key: 'deposits', name: 'Nạp / Rút tiền', isDate: true },
        { key: 'withdrawals', name: 'Lịch sử rút tiền', isDate: true },
        { key: 'bet-orders', name: 'Đơn cược bên thứ 3', isDate: true },
        { key: 'lottery-bets', name: 'Đơn cược xổ số', isDate: true },
        { key: 'lottery-bets-summary', name: 'Tổng hợp đơn cược xổ số', isDate: true },
        { key: 'report-lottery', name: 'Báo cáo xổ số', isDate: true },
        { key: 'report-funds', name: 'Sao kê giao dịch', isDate: true },
        { key: 'report-third', name: 'Báo cáo nhà cung cấp game', isDate: true }
      ];

      // Populate endpoint filter dropdown
      var epSel = $('#filterEndpoint');
      STATIC_EPS.forEach(function (ep) {
        epSel.append('<option value="' + ep.key + '">' + ep.name + '</option>');
      });
      form.render('select');

      // ═══════════════════════════════════════
      // ── Helpers ──
      // ═══════════════════════════════════════

      function fmtElapsed(ms) {
        var s = Math.round(ms / 1000);
        if (s < 60) return s + 's';
        return Math.floor(s / 60) + 'm' + String(s % 60).padStart(2, '0') + 's';
      }

      function setNum(id, val) {
        var el = document.getElementById(id);
        if (el) el.textContent = val;
      }

      // ═══════════════════════════════════════
      // ── Build tree data ──
      // ═══════════════════════════════════════

      function buildTreeData() {
        var snapMap = {};
        if (snap && snap.agents) {
          snap.agents.forEach(function (a) { snapMap[a.agentId] = a; });
        }

        return agents.map(function (a) {
          var pa = snapMap[a.id];
          var isSyncing = pa && pa.status === 'syncing';

          var node = {
            id: a.id,
            name: a.label,
            isAgent: true,
            agentId: a.id,
            lockedDays: a.lockedDays || 0,
            agentStatus: a.status,
            syncing: isSyncing,
            elapsed: isSyncing ? (pa.elapsed || 0) : 0
          };

          if (isSyncing && pa.endpoints && pa.endpoints.length > 0) {
            node.children = pa.endpoints.map(function (ep, idx) {
              return {
                id: a.id * 1000 + idx + 1,
                name: ep.name || ep.key,
                epKey: ep.key,
                isAgent: false,
                total: ep.total,
                completed: ep.completed,
                dataRows: ep.rows || 0,
                epStatus: ep.status
              };
            });
          } else {
            var locked = a.lockedDays || 0;
            node.children = STATIC_EPS.map(function (ep, idx) {
              var total, completed, rows, status;
              if (ep.isDate) {
                total = 65; completed = locked; rows = 0;
                status = locked >= 65 ? 'done' : 'idle';
              } else {
                total = 1;
                rows = ep.key === 'members' ? (a.memberRows || 0) : (ep.key === 'invites' ? (a.inviteRows || 0) : 0);
                completed = rows > 0 ? 1 : 0;
                status = rows > 0 ? 'done' : 'idle';
              }
              return {
                id: a.id * 1000 + idx + 1,
                name: ep.name,
                epKey: ep.key,
                isAgent: false,
                total: total,
                completed: completed,
                dataRows: rows,
                epStatus: status
              };
            });
          }

          return node;
        });
      }

      // ═══════════════════════════════════════
      // ── Filter tree data ──
      // ═══════════════════════════════════════

      function filterTreeData(data) {
        if (!currentFilter.agent_id && !currentFilter.endpoint && !currentFilter.status) {
          return data;
        }
        var result = [];
        data.forEach(function (agent) {
          if (currentFilter.agent_id && String(agent.id) !== String(currentFilter.agent_id)) return;
          var children = agent.children || [];
          if (currentFilter.endpoint || currentFilter.status) {
            children = children.filter(function (c) {
              if (currentFilter.endpoint && c.epKey !== currentFilter.endpoint) return false;
              if (currentFilter.status && c.epStatus !== currentFilter.status) return false;
              return true;
            });
            if (children.length === 0) return;
          }
          var cloned = {};
          for (var k in agent) { if (agent.hasOwnProperty(k)) cloned[k] = agent[k]; }
          cloned.children = children;
          result.push(cloned);
        });
        return result;
      }

      // ═══════════════════════════════════════
      // ── Render tree ──
      // ═══════════════════════════════════════

      var barToolbarHtml = '<div class="layui-btn-group">'
        + '<button class="layui-btn layui-btn-xs layui-btn-normal" lay-event="syncAll">'
        + '<i class="hi hi-arrows-rotate"></i> Đồng bộ tất cả'
        + '</button>'
        + '<button class="layui-btn layui-btn-xs layui-btn-danger" lay-event="clearSelected">'
        + '<i class="hi hi-trash-can"></i> Xoá khoá đã chọn'
        + '</button>'
        + '</div><span id="syncingIndicator"></span>';

      function renderTree() {
        var data = filterTreeData(buildTreeData());
        if (!rendered) {
          treeTable.render({
            id: 'syncTree',
            elem: '#syncTree',
            toolbar: barToolbarHtml,
            defaultToolbar: ['filter'],
            data: data,
            tree: {
              customName: { children: 'children' },
              view: { showIcon: false }
            },
            size: 'sm',
            even: true,
            cols: [[
              { type: 'checkbox', width: 50 },
              { field: 'name', title: 'Đại lý / Loại dữ liệu', minWidth: 200, templet: function (d) {
                if (d.isAgent) {
                  var c = d.agentStatus === 1 ? '#16b777' : '#ff5722';
                  return '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:'
                    + c + ';margin-right:6px;vertical-align:middle;"></span><b>' + d.name + '</b>';
                }
                return '<span style="color:#1e9fff;">' + d.name + '</span>';
              }},
              { title: 'Trạng thái', width: 130, align: 'center', templet: function (d) {
                if (d.isAgent) {
                  if (d.syncing) return '<span style="color:#1e9fff;font-weight:600;">Đang chạy</span>';
                  return d.agentStatus === 1
                    ? '<span style="color:#16b777;font-weight:600;">Hoạt động</span>'
                    : '<span style="color:#ff5722;font-weight:600;">Khoá</span>';
                }
                if (d.epStatus === 'done') return '<span style="color:#16b777;font-weight:600;">Hoàn tất</span>';
                if (d.epStatus === 'error') return '<span style="color:#ff5722;font-weight:600;">Lỗi</span>';
                if (d.epStatus === 'syncing') return '<span style="color:#1e9fff;font-weight:600;">Đang chạy</span>';
                if (d.epStatus === 'pending') return '<span style="color:#999;">Chờ</span>';
                return '<span style="color:#666;">\u2014</span>';
              }},
              { title: 'Tiến trình', minWidth: 180, templet: function (d) {
                var completed, total, color;
                if (d.isAgent) {
                  completed = d.lockedDays; total = 65;
                } else {
                  completed = d.completed || 0; total = d.total || 0;
                }
                var pct = total > 0 ? Math.round((completed / total) * 100) : 0;
                if (pct > 100) pct = 100;
                if (d.isAgent) {
                  color = pct >= 100 ? '#16b777' : pct >= 50 ? '#ffb800' : '#ff5722';
                } else {
                  color = d.epStatus === 'done' ? '#16b777' : d.epStatus === 'error' ? '#ff5722' : d.epStatus === 'idle' ? '#999' : '#1e9fff';
                }
                return '<div style="display:flex;align-items:center;gap:8px;">'
                  + '<div style="flex:1;height:6px;background:rgba(0,0,0,0.06);border-radius:3px;overflow:hidden;">'
                  + '<div style="width:' + pct + '%;height:100%;background:' + color + ';border-radius:3px;transition:width .3s;"></div></div>'
                  + '<span style="font-size:12px;color:' + color + ';font-weight:600;white-space:nowrap;">'
                  + completed + '/' + total + '</span></div>';
              }},
              { title: 'Dòng', width: 100, align: 'right', templet: function (d) {
                if (d.isAgent) return '';
                return d.dataRows > 0
                  ? '<span style="font-weight:600;">' + d.dataRows.toLocaleString() + '</span>'
                  : '<span style="color:#999;">\u2014</span>';
              }},
              { title: 'Ngày khoá', width: 100, align: 'center', templet: function (d) {
                if (d.isAgent) {
                  var ld = d.lockedDays || 0;
                  if (ld > 0) return '<span style="color:#ffb800;"><i class="hi hi-lock" style="font-size:14px;"></i> ' + ld + '</span>';
                  return '<span style="color:#999;">0</span>';
                }
                return '';
              }},
              { title: 'Thời gian', width: 90, align: 'right', templet: function (d) {
                if (!d.isAgent || !d.elapsed) return '';
                return '<span style="font-size:12px;color:#1e9fff;">' + fmtElapsed(d.elapsed) + '</span>';
              }},
              { title: 'Thao tác', width: 200, align: 'center', toolbar: '#toolbarTpl' }
            ]],
            done: function () {
              HubLang.applyDOM();
            }
          });
          rendered = true;
        } else {
          treeTable.reloadData('syncTree', { data: data });
        }
      }

      // ═══════════════════════════════════════
      // ── Events ──
      // ═══════════════════════════════════════

      // Table-level toolbar
      treeTable.on('toolbar(syncTree)', function (obj) {
        if (obj.event === 'syncAll') {
          layer.confirm('Đồng bộ tất cả agents?', { icon: 3 }, function (idx) {
            layer.close(idx);
            var loadIdx = layer.load(2, { shade: [0.3, '#000'] });
            HubAPI.adminRequest('sync/run-all', 'POST', {}).then(function (res) {
              layer.close(loadIdx);
              if (res.code === 0) {
                layer.msg('Đã bắt đầu đồng bộ', { icon: 1 });
                setTimeout(loadAgents, 2000);
              } else {
                layer.msg(res.msg || 'Lỗi', { icon: 2 });
              }
            }).catch(function () {
              layer.close(loadIdx);
              layer.msg('Lỗi kết nối', { icon: 2 });
            });
          });
        } else if (obj.event === 'clearSelected') {
          var checked = treeTable.checkStatus('syncTree');
          var selectedIds = [];
          if (checked && checked.data) {
            checked.data.forEach(function (row) {
              if (row.isAgent && row.id) selectedIds.push(row.id);
            });
          }
          if (selectedIds.length === 0) {
            layer.msg('Chưa chọn tài khoản nào', { icon: 0 });
            return;
          }
          layer.confirm('Xoá khoá ngày của ' + selectedIds.length + ' đại lý đã chọn?', { icon: 3 }, function (idx) {
            layer.close(idx);
            var loadIdx = layer.load();
            var promises = selectedIds.map(function (aid) {
              return HubAPI.adminRequest('sync/clear', 'POST', { agent_id: aid });
            });
            Promise.all(promises).then(function () {
              layer.close(loadIdx);
              layer.msg('Đã xoá', { icon: 1 });
              loadAgents();
            }).catch(function () {
              layer.close(loadIdx);
              layer.msg('Lỗi kết nối', { icon: 2 });
            });
          });
        }
      });

      // Row-level tool
      treeTable.on('tool(syncTree)', function (obj) {
        var d = obj.data;
        if (!d.isAgent) return;

        if (obj.event === 'sync') {
          layer.confirm('Đồng bộ "' + d.name + '"?', { icon: 3 }, function (idx) {
            layer.close(idx);
            HubAPI.adminRequest('sync/run', 'POST', { agent_id: d.agentId }).then(function (res) {
              if (res.code === 0) {
                layer.msg('Đã bắt đầu đồng bộ', { icon: 1 });
                setTimeout(loadAgents, 2000);
              } else {
                layer.msg(res.msg || 'Lỗi', { icon: 2 });
              }
            }).catch(function () { layer.msg('Lỗi kết nối', { icon: 2 }); });
          });
        } else if (obj.event === 'clear') {
          layer.confirm('Xoá tất cả khoá ngày của "' + d.name + '"?', { icon: 3 }, function (idx) {
            layer.close(idx);
            HubAPI.adminRequest('sync/clear', 'POST', { agent_id: d.agentId }).then(function (res) {
              if (res.code === 0) {
                layer.msg(res.msg || 'Đã xoá', { icon: 1 });
                loadAgents();
              } else {
                layer.msg(res.msg || 'Lỗi', { icon: 2 });
              }
            }).catch(function () { layer.msg('Lỗi kết nối', { icon: 2 }); });
          });
        }
      });

      // Filter
      form.on('submit(doSearch)', function (data) {
        currentFilter = {};
        if (data.field.agent_id) currentFilter.agent_id = data.field.agent_id;
        if (data.field.endpoint) currentFilter.endpoint = data.field.endpoint;
        if (data.field.status) currentFilter.status = data.field.status;
        renderTree();
        return false;
      });

      document.getElementById('btnReset').addEventListener('click', function () {
        currentFilter = {};
        setTimeout(function () {
          form.render('select');
          renderTree();
        }, 50);
      });

      // ═══════════════════════════════════════
      // ── Data loading ──
      // ═══════════════════════════════════════

      function loadAgents() {
        HubAPI.adminGet('sync/status').then(function (res) {
          if (res.code !== 0) return;
          var d = res.data;
          agents = d.agents || [];

          // Stat cards
          var active = agents.filter(function (a) { return a.status === 1; }).length;
          var full = agents.filter(function (a) { return (a.lockedDays || 0) >= 65; }).length;
          setNum('statTotalAgents', agents.length);
          setNum('statActiveAgents', active);
          setNum('statFullySynced', full + '/' + agents.length);

          var stateEl = document.getElementById('statSyncState');
          if (stateEl) {
            stateEl.textContent = d.syncing ? 'Đang chạy' : 'Sẵn sàng';
            stateEl.style.color = d.syncing ? '#ff4d4f' : '#16b777';
          }

          // Syncing indicator in toolbar
          var ind = document.getElementById('syncingIndicator');
          if (ind) {
            ind.innerHTML = d.syncing
              ? '<span class="layui-btn layui-btn-xs" style="background:#1e9fff;border-color:#1e9fff;cursor:default;margin-left:10px;">'
                + '<i class="hi hi-spinner"></i> Đang đồng bộ...</span>'
              : '';
          }

          // Progress polling
          if (d.syncing && !pollTimer) {
            startProgressPoll();
          } else if (!d.syncing && pollTimer) {
            stopProgressPoll();
            snap = null;
          }

          renderTree();
        }).catch(function () {});
      }

      function pollProgress() {
        HubAPI.adminGet('sync/progress-data').then(function (res) {
          if (res.code !== 0 || !res.data) return;
          if (!res.data.agents || res.data.agents.length === 0) {
            snap = null;
            stopProgressPoll();
            loadAgents();
            return;
          }
          snap = res.data;
          renderTree();
        }).catch(function () {});
      }

      function startProgressPoll() {
        if (pollTimer) return;
        pollProgress();
        pollTimer = setInterval(pollProgress, 3000);
      }

      function stopProgressPoll() {
        if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
      }

      function loadAgentFilter() {
        HubAPI.adminGet('agents').then(function (res) {
          if (res.code !== 0 || !res.data) return;
          var sel = $('#filterAgent');
          res.data.forEach(function (a) {
            sel.append('<option value="' + a.id + '">' + a.label + '</option>');
          });
          form.render('select');
        }).catch(function () {});
      }

      // ── Init ──
      loadAgents();
      loadAgentFilter();
      statsTimer = setInterval(loadAgents, 30000);

      window.addEventListener('beforeunload', function () {
        if (pollTimer) clearInterval(pollTimer);
        if (statsTimer) clearInterval(statsTimer);
      });
    });
  </script>
</body>
</html>
