<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mã giới thiệu</title>
    <link rel="stylesheet" href="/lib/layui/css/layui.css" />
    <style>
      body {
        margin: 0;
        padding: 0;
        background: #f2f2f2;
        font-family: sans-serif;
      }
      .layui-card {
        margin: 15px;
      }
      .layui-card-header {
        padding-bottom: 0;
        border-bottom: none;
      }
      .layui-field-box .layui-inline {
        margin-bottom: 8px;
      }
      .layui-field-box .layui-inline label {
        font-size: 13px;
        margin-right: 5px;
      }
    </style>
  </head>
  <body>
    <!-- ── Toolbar template ── -->
    <script type="text/html" id="toolbarTpl">
      <div class="layui-btn-group">
        <button class="layui-btn layui-btn-xs" lay-event="addInvite">
          <i class="layui-icon layui-icon-addition"></i
          ><span data-i18n="addInviteBtn">Thêm mã giới thiệu</span>
        </button>
      </div>
    </script>

    <!-- ── Thao tác từng dòng ── -->
    <script type="text/html" id="rowActionTpl">
      <button
        class="layui-btn layui-btn-xs layui-btn-normal"
        lay-event="copyLink"
      >
        <span data-i18n="copyLink">Copy đường link</span>
      </button>
      <button
        class="layui-btn layui-btn-xs layui-btn-warm"
        lay-event="viewConfig"
      >
        <span data-i18n="viewConfig">Xem cài đặt</span>
      </button>
      <button
        class="layui-btn layui-btn-xs layui-btn-danger"
        lay-event="qrCode"
      >
        <span data-i18n="qrCode">Mã QR</span>
      </button>
      <button class="layui-btn layui-btn-xs" lay-event="edit">
        <span data-i18n="editBtn">Chỉnh sửa</span>
      </button>
    </script>

    <div class="layui-row">
      <div class="layui-col-md12">
        <div class="layui-card">
          <div class="layui-form layui-card-header">
            <fieldset class="layui-elem-field">
              <legend data-i18n="referralCode">Mã giới thiệu</legend>
              <div class="layui-field-box">
                <form class="layui-form" lay-filter="searchForm">
                  <div class="layui-inline">
                    <label data-i18n="addedTime">Thời gian thêm vào</label>：
                    <div style="width: 290px" class="layui-input-inline">
                      <input
                        type="text"
                        name="create_time"
                        id="createTime"
                        placeholder="Thời gian bắt đầu - Thời gian kết thúc"
                        data-i18n="dateStartEndTime"
                        data-i18n-attr="placeholder"
                        class="layui-input"
                        readonly
                        autocomplete="off"
                      />
                    </div>
                  </div>
                  <div class="layui-inline">
                    <label data-i18n="memberLoginTime"
                      >Thời gian hội viên đăng nhập</label
                    >：
                    <div style="width: 290px" class="layui-input-inline">
                      <input
                        type="text"
                        name="user_register_time"
                        id="registerTime"
                        placeholder="Thời gian bắt đầu - Thời gian kết thúc"
                        data-i18n="dateStartEndTime"
                        data-i18n-attr="placeholder"
                        class="layui-input"
                        readonly
                        autocomplete="off"
                      />
                    </div>
                  </div>
                  <div class="layui-inline">
                    <label data-i18n="referralCode">Mã giới thiệu</label>：
                    <div style="width: 240px" class="layui-input-inline">
                      <input
                        type="text"
                        name="invite_code"
                        placeholder="Nhập đầy đủ mã giới thiệu"
                        data-i18n="enterInviteCode"
                        data-i18n-attr="placeholder"
                        class="layui-input"
                        autocomplete="off"
                      />
                    </div>
                  </div>
                  <div class="layui-inline">
                    <button
                      type="button"
                      class="layui-btn"
                      lay-submit
                      lay-filter="doSearch"
                    >
                      <i class="layui-icon layui-icon-search"></i>
                      <span data-i18n="search">Tìm kiếm</span>
                    </button>
                  </div>
                  <div class="layui-inline">
                    <button
                      type="reset"
                      class="layui-btn layui-btn-primary"
                      id="btnReset"
                    >
                      <i class="layui-icon layui-icon-refresh"></i>
                      <span data-i18n="reset">Đặt lại</span>
                    </button>
                  </div>
                </form>
              </div>
            </fieldset>
          </div>
          <div class="layui-card-body">
            <table id="dataTable" lay-filter="dataTable"></table>
          </div>
        </div>
      </div>
    </div>

    <script src="/lib/layui/layui.js"></script>
    <script src="/js/hub-utils.js"></script>
    <script src="/js/hub-lang.js"></script>
    <script src="/js/hub-crypto.js?v=3"></script>
    <script src="/js/hub-api.js?v=3"></script>
    <script>
      layui.use(['table', 'form', 'laydate', 'layer'], function () {
        HubLang.init();
        var table = layui.table;
        var form = layui.form;
        var laydate = layui.laydate;
        var layer = layui.layer;
        var $ = layui.$;

        // ── Helper: parse rebate_arr ──
        var SERIES_NAMES = {
          1: 'MN',
          2: 'MB',
          3: 'MT',
          4: 'XSN',
          5: 'Sicbo',
          6: 'XSN',
          7: 'Keno',
          8: 'WinGo',
          9: 'Game'
        };
        function parseRebate(raw) {
          try {
            var obj = typeof raw === 'string' ? JSON.parse(raw) : raw;
            if (!obj || typeof obj !== 'object') return [];
            var arr = [];
            for (var k in obj) {
              arr.push({
                id: k,
                name: SERIES_NAMES[k] || k,
                value: obj[k].value
              });
            }
            return arr;
          } catch (e) {
            return [];
          }
        }

        // ── Helper: generate invite link ──
        function getInviteLink(code) {
          return window.location.origin + '/register?invite=' + code;
        }

        laydate.render({
          elem: '#createTime',
          type: 'datetime',
          range: '|',
          rangeLinked: true
        });
        laydate.render({
          elem: '#registerTime',
          type: 'datetime',
          range: '|',
          rangeLinked: true
        });

        table.render({
          elem: '#dataTable',
          url: '/api/data/invites',
          method: 'get',
          toolbar: '#toolbarTpl',
          defaultToolbar: ['filter', 'print', 'exports'],
          page: true,
          limit: 10,
          text: { none: HubLang.t('noData') },
          parseData: function (res) {
            return {
              code: res.code === 0 ? 0 : 1,
              msg: res.msg || '',
              count: res.count || 0,
              data: res.data || []
            };
          },
          request: { pageName: 'page', limitName: 'limit' },
          cols: [
            [
              { field: 'invite_code', title: HubLang.t('referralCode') },
              { field: 'user_type', title: HubLang.t('inviteType') },
              { field: 'reg_count', title: HubLang.t('totalRegistered') },
              { field: 'scope_reg_count', title: HubLang.t('registeredUsers') },
              { field: 'recharge_count', title: HubLang.t('rechargeCount') },
              {
                field: 'first_recharge_count',
                title: HubLang.t('firstRechargeDay')
              },
              {
                field: 'register_recharge_count',
                title: HubLang.t('registerRechargeDay')
              },
              { field: 'remark', title: HubLang.t('remark') },
              { field: 'create_time', title: HubLang.t('addedTime') },
              { field: 'id', title: 'ID', width: 90 },
              { field: 'uid', title: 'UID', width: 90 },
              { field: 'group_id', title: HubLang.t('groupId'), width: 80 },
              {
                field: 'rebate_arr',
                title: HubLang.t('rebateArr'),
                minWidth: 260,
                templet: function (d) {
                  try {
                    var obj =
                      typeof d.rebate_arr === 'string'
                        ? JSON.parse(d.rebate_arr)
                        : d.rebate_arr;
                    if (!obj || typeof obj !== 'object')
                      return d.rebate_arr || '';
                    var names = {
                      1: 'MN',
                      2: 'MB',
                      3: 'MT',
                      4: 'XSN',
                      5: 'Sicbo',
                      6: 'XSN',
                      7: 'Keno',
                      8: 'WinGo',
                      9: 'Game'
                    };
                    var parts = [];
                    for (var k in obj) {
                      parts.push((names[k] || k) + ':' + obj[k].value);
                    }
                    return parts.join(', ');
                  } catch (e) {
                    return d.rebate_arr || '';
                  }
                }
              },
              {
                field: 'update_time',
                title: HubLang.t('updateTime'),
                width: 160
              },
              {
                fixed: 'right',
                title: HubLang.t('actions'),
                minWidth: 360,
                toolbar: '#rowActionTpl'
              }
            ]
          ],
          done: function (res) {
            HubLang.applyDOM();
            document.title = HubLang.t('inviteTitle');
            console.log(
              '[inviteList] Đã tải ' +
                (res.data ? res.data.length : 0) +
                '/' +
                res.count +
                ' mã giới thiệu'
            );
          }
        });

        // ── Toolbar events ──
        table.on('toolbar(dataTable)', function (obj) {
          if (obj.event === 'addInvite') {
            openInviteForm();
          }
        });

        // ── Row action events ──
        table.on('tool(dataTable)', function (obj) {
          var d = obj.data;
          switch (obj.event) {
            case 'copyLink':
              var link = getInviteLink(d.invite_code);
              navigator.clipboard
                .writeText(link)
                .then(function () {
                  layer.msg(HubLang.t('copied') + link, {
                    icon: 1,
                    time: 2000
                  });
                })
                .catch(function () {
                  // Fallback cho trình duyệt không hỗ trợ clipboard API
                  var input = document.createElement('input');
                  input.value = link;
                  document.body.appendChild(input);
                  input.select();
                  document.execCommand('copy');
                  document.body.removeChild(input);
                  layer.msg(HubLang.t('copied') + link, {
                    icon: 1,
                    time: 2000
                  });
                });
              break;

            case 'viewConfig':
              var rebates = parseRebate(d.rebate_arr);
              var html = '<table class="layui-table" style="margin:10px 0;">';
              html +=
                '<thead><tr><th>' +
                HubLang.t('configType') +
                '</th><th>' +
                HubLang.t('rebateTitle') +
                '</th></tr></thead><tbody>';
              if (rebates.length === 0) {
                html +=
                  '<tr><td colspan="2" style="text-align:center;">' +
                  HubLang.t('notConfigured') +
                  '</td></tr>';
              } else {
                for (var i = 0; i < rebates.length; i++) {
                  html +=
                    '<tr><td>' +
                    rebates[i].name +
                    '</td><td>' +
                    rebates[i].value +
                    '</td></tr>';
                }
              }
              html += '</tbody></table>';
              layer.open({
                type: 1,
                title:
                  HubLang.t('configTitle') + HubUtils.escapeHtml(d.invite_code),
                area: ['400px', 'auto'],
                shadeClose: true,
                content: '<div style="padding:15px;">' + html + '</div>'
              });
              break;

            case 'qrCode':
              var qrLink = getInviteLink(d.invite_code);
              var qrUrl =
                'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' +
                encodeURIComponent(qrLink);
              layer.open({
                type: 1,
                title:
                  HubLang.t('qrTitle') + HubUtils.escapeHtml(d.invite_code),
                area: ['300px', 'auto'],
                shadeClose: true,
                content:
                  '<div style="padding:20px;text-align:center;">' +
                  '<img src="' +
                  qrUrl +
                  '" style="width:200px;height:200px;" />' +
                  '<p style="margin-top:10px;font-size:12px;color:#999;word-break:break-all;">' +
                  qrLink +
                  '</p>' +
                  '</div>'
              });
              break;

            case 'edit':
              openInviteForm(d);
              break;
          }
        });

        // ── Form thêm / chỉnh sửa mã giới thiệu ──
        function openInviteForm(data) {
          var isEdit = !!data;
          var title = isEdit
            ? HubLang.t('editInviteCode') + data.invite_code
            : HubLang.t('addInviteBtn');

          var rebates = isEdit ? parseRebate(data.rebate_arr) : [];
          var rebateInputs = '';
          var defaultSeries = [
            { id: '1', name: 'MN' },
            { id: '2', name: 'MB' },
            { id: '3', name: 'MT' },
            { id: '4', name: 'XSN' },
            { id: '5', name: 'Sicbo' },
            { id: '7', name: 'Keno' },
            { id: '8', name: 'WinGo' },
            { id: '9', name: 'Game' }
          ];
          var seriesList = rebates.length > 0 ? rebates : defaultSeries;
          for (var i = 0; i < seriesList.length; i++) {
            var val = seriesList[i].value || '';
            rebateInputs +=
              '<div class="layui-form-item">' +
              '<label class="layui-form-label">' +
              seriesList[i].name +
              '</label>' +
              '<div class="layui-input-block">' +
              '<input type="number" name="rebate_' +
              seriesList[i].id +
              '" value="' +
              val +
              '" placeholder="0" class="layui-input" step="0.1" min="0" max="15">' +
              '</div></div>';
          }

          var formHtml =
            '<form class="layui-form" lay-filter="inviteForm" style="padding:15px 30px 0 0;">' +
            '<div class="layui-form-item">' +
            '<label class="layui-form-label">' +
            HubLang.t('remark') +
            '</label>' +
            '<div class="layui-input-block">' +
            '<input type="text" name="remark" value="' +
            (isEdit ? HubUtils.escapeHtml(data.remark) : '') +
            '" placeholder="' +
            HubLang.t('inviteDescription') +
            '" class="layui-input">' +
            '</div></div>' +
            '<fieldset class="layui-elem-field" style="margin:0 0 10px 110px;">' +
            '<legend style="font-size:13px;">' +
            HubLang.t('rebateTitle') +
            '</legend>' +
            '<div class="layui-field-box" style="padding:5px 15px;">' +
            rebateInputs +
            '</div>' +
            '</fieldset>' +
            '<div class="layui-form-item">' +
            '<div class="layui-input-block">' +
            '<button type="button" class="layui-btn" lay-submit lay-filter="submitInvite">' +
            HubLang.t('confirm') +
            '</button>' +
            '<button type="reset" class="layui-btn layui-btn-primary">' +
            HubLang.t('reset') +
            '</button>' +
            '</div></div></form>';

          var layerIdx = layer.open({
            type: 1,
            title: title,
            area: ['550px', 'auto'],
            content: formHtml,
            success: function () {
              form.render();
            }
          });

          form.on('submit(submitInvite)', function (formData) {
            var body = { remark: formData.field.remark };
            // Build rebate_arr JSON
            var rebateObj = {};
            for (var key in formData.field) {
              if (key.indexOf('rebate_') === 0) {
                var sid = key.replace('rebate_', '');
                rebateObj[sid] = { value: formData.field[key] || '0' };
              }
            }
            body.rebate_arr = JSON.stringify(rebateObj);

            if (isEdit) {
              body.id = data.id;
              body.invite_code = data.invite_code;
            }

            var actionUrl = isEdit
              ? '/api/action/editInvite'
              : '/api/action/addInvite';
            var loadIdx = layer.load();
            $.ajax({
              url: actionUrl,
              type: 'POST',
              contentType: 'application/json',
              data: JSON.stringify(body),
              success: function (res) {
                layer.close(loadIdx);
                if (res.code === 0 || res.code === 1) {
                  layer.close(layerIdx);
                  layer.msg(
                    isEdit ? HubLang.t('updated') : HubLang.t('inviteAdded'),
                    { icon: 1 }
                  );
                  table.reload('dataTable');
                } else {
                  layer.msg(res.msg || HubLang.t('failed'), { icon: 2 });
                }
              },
              error: function () {
                layer.close(loadIdx);
                layer.msg(HubLang.t('connectionError'), { icon: 2 });
              }
            });
            return false;
          });
        }

        // ── Tìm kiếm ──
        form.on('submit(doSearch)', function (data) {
          table.reload('dataTable', { where: data.field, page: { curr: 1 } });
          return false;
        });

        // ── Đặt lại ──
        document
          .getElementById('btnReset')
          .addEventListener('click', function () {
            setTimeout(function () {
              form.render('select');
              document.getElementById('createTime').value = '';
              document.getElementById('registerTime').value = '';
              table.reload('dataTable', {
                where: {
                  invite_code: '',
                  create_time: '',
                  user_register_time: ''
                },
                page: { curr: 1 }
              });
            }, 50);
          });
      });
    </script>
  </body>
</html>
